<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Auden Shield — Calligram Poem-Engine</title>
<style>
:root {
  --bg: #f6f2e8;
  --paper: #fbf8f0;
  --ink: #111;
  --muted: rgba(17,17,17,.65);
  --hair: rgba(17,17,17,.14);
  --accent: #1b4b7a;
  --accent2: #8a3d1e;
  --cell: 22px;
  --radius: 18px;
  --shadow: 0 10px 30px rgba(0,0,0,.08);
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
}
* { box-sizing: border-box; }
html, body { height: 100%; background: radial-gradient(1200px 800px at 30% -10%, #fff 0%, var(--bg) 60%, #efe8d7 100%); color: var(--ink); margin: 0; font-family: var(--sans); }
.app { min-height: 100%; display: grid; grid-template-rows: auto 1fr; gap: 12px; padding: 12px; }
header {
  background: linear-gradient(to bottom, rgba(251,248,240,.96), rgba(251,248,240,.78));
  border: 1px solid var(--hair);
  border-radius: var(--radius);
  padding: 14px;
  backdrop-filter: blur(10px);
  box-shadow: var(--shadow);
}
.title { font-weight: 700; font-size: 14px; letter-spacing: .06em; text-transform: uppercase; }
.subtitle { color: var(--muted); font-size: 12px; margin-top: 6px; }
.controls { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; align-items: center; }
button {
  appearance: none;
  border: 1px solid var(--hair);
  background: #fff;
  color: var(--ink);
  font-weight: 600;
  font-size: 12px;
  padding: 8px 14px;
  border-radius: 999px;
  cursor: pointer;
  box-shadow: 0 1px 0 rgba(0,0,0,.03);
  transition: all .12s;
}
button:hover { border-color: #bbb; box-shadow: 0 6px 16px rgba(0,0,0,.06); }
button.primary { background: var(--ink); color: var(--paper); border-color: var(--ink); }
.pill { font-family: var(--mono); font-size: 11px; padding: 7px 10px; border: 1px solid var(--hair); border-radius: 999px; color: var(--muted); background: #fff; }
main { display: flex; justify-content: center; align-items: flex-start; overflow: auto; padding: 20px; background: var(--paper); border-radius: var(--radius); border: 1px solid var(--hair); }
.grid {
  display: grid;
  grid-template-columns: repeat(24, var(--cell));
  grid-auto-rows: var(--cell);
  gap: 1px;
  background: var(--hair);
  border: 1px solid var(--hair);
  border-radius: 14px;
  overflow: hidden;
  box-shadow: var(--shadow);
}
.cell {
  position: relative;
  background: var(--paper);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--mono);
  font-size: 10px;
  line-height: 1;
  cursor: pointer;
  transition: all .15s;
}
.cell:hover { background: rgba(27,75,122,.12); z-index: 2; }
.cell.blank { background: rgba(17,17,17,.04); cursor: default; }

/* Stroke weights */
.w-HAIRLINE { font-weight: 300; opacity: .45; }
.w-LIGHT { font-weight: 400; opacity: .65; }
.w-REGULAR { font-weight: 500; opacity: .85; }
.w-BOLD { font-weight: 700; opacity: 1; }
.w-BLACK { font-weight: 800; opacity: 1; }

/* Gravity */
.g-TOP { align-items: flex-start; padding-top: 2px; }
.g-BOTTOM { align-items: flex-end; padding-bottom: 2px; }
.g-LEFT { justify-content: flex-start; padding-left: 2px; }
.g-RIGHT { justify-content: flex-end; padding-right: 2px; }
.g-CENTER { align-items: center; justify-content: center; }

/* Letter materials */
.m-INK { color: #111; }
.m-STONE { color: #5a5248; }
.m-ASH { color: rgba(60,60,60,.5); }
.m-IRON { color: #4a4a52; }
.m-LEAD { color: #6a6a70; }
.m-BLOOD { color: #8a2a2a; }
.m-DUST { color: #8a7a68; }

/* Zones */
.z-THETIS { background: rgba(27,75,122,.08); }
.z-WILDERNESS { background: rgba(138,61,30,.06); }
.z-MULTITUDE { background: rgba(80,80,90,.08); }
.z-VOICE { background: rgba(100,100,120,.06); }
.z-ALTAR { background: rgba(138,30,30,.08); }
.z-CAMP { background: rgba(100,80,60,.08); }
.z-EXECUTION { background: rgba(120,40,40,.1); }
.z-FIELD { background: rgba(60,80,50,.08); }
.z-URCHIN { background: rgba(80,80,60,.08); }
.z-FORGE { background: rgba(180,100,40,.1); }

/* Calligram functions */
.f-IMAGE { outline: 1px solid rgba(27,75,122,.2); outline-offset: -1px; }
.f-CONTAINER { outline: 1px solid rgba(17,17,17,.1); outline-offset: -1px; }
.f-PATH { outline: 1px solid rgba(30,100,50,.15); outline-offset: -1px; }
.f-BARRIER { outline: 1px solid rgba(138,30,30,.2); outline-offset: -1px; }
.f-VOID { outline: 1px solid rgba(17,17,17,.05); outline-offset: -1px; }

.highlight { outline: 2px solid var(--accent) !important; z-index: 3; }

.toast {
  position: fixed;
  left: 10px; right: 10px; bottom: 10px;
  border: 1px solid var(--hair);
  background: rgba(251,248,240,.96);
  border-radius: 16px;
  padding: 12px;
  backdrop-filter: blur(10px);
  display: none;
  z-index: 999;
  max-height: 40vh;
  overflow: auto;
  box-shadow: var(--shadow);
}
.toast .head { display: flex; justify-content: space-between; align-items: center; font-weight: 700; font-size: 13px; }
.toast .body { margin-top: 8px; font-family: var(--mono); font-size: 11px; white-space: pre-wrap; color: var(--muted); }
.xbtn { border: 1px solid var(--hair); background: #fff; color: var(--muted); border-radius: 999px; padding: 6px 10px; font-size: 11px; cursor: pointer; }
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="title">Auden Shield — Calligram Poem-Engine</div>
    <div class="subtitle">W.H. Auden's "The Shield of Achilles" as 24×24 calligrammatic grid · GlyphFlow + LetterMaterial + TypographicGravity</div>
    <div class="controls">
      <button id="regenerate">⟳ Regenerate</button>
      <button id="traverse">▷ Traverse</button>
      <span class="pill" id="stats">576 cells</span>
    </div>
  </header>
  <main>
    <div class="grid" id="grid"></div>
  </main>
  <div class="toast" id="toast">
    <div class="head">
      <span id="toastTitle">Cell</span>
      <button class="xbtn" id="toastClose">Close</button>
    </div>
    <div class="body" id="toastBody"></div>
  </div>
</div>

<script>
const POEM = {
  title: "The Shield of Achilles",
  author: "W.H. Auden",
  stanzas: [
    { type: "thetis", lines: [
      "She looked over his shoulder",
      "For vines and olive trees,",
      "Marble well-governed cities",
      "And ships upon untamed seas,",
      "But there on the shining metal",
      "His hands had put instead",
      "An artificial wilderness",
      "And a sky like lead."
    ]},
    { type: "scene", lines: [
      "A plain without a feature, bare and brown,",
      "No blade of grass, no sign of neighborhood,",
      "Nothing to eat and nowhere to sit down,",
      "Yet, congregated on its blankness, stood",
      "An unintelligible multitude,",
      "A million eyes, a million boots in line,",
      "Without expression, waiting for a sign."
    ]},
    { type: "scene", lines: [
      "Out of the air a voice without a face",
      "Proved by statistics that some cause was just",
      "In tones as dry and level as the place:",
      "No one was cheered and nothing was discussed;",
      "Column by column in a cloud of dust",
      "They marched away enduring a belief",
      "Whose logic brought them, somewhere else, to grief."
    ]},
    { type: "thetis", lines: [
      "She looked over his shoulder",
      "For ritual pieties,",
      "White flower-garlanded heifers,",
      "Libation and sacrifice,",
      "But there on the shining metal",
      "Where the altar should have been,",
      "She saw by his flickering forge-light",
      "Quite another scene."
    ]},
    { type: "scene", lines: [
      "Barbed wire enclosed an arbitrary spot",
      "Where bored officials lounged (one cracked a joke)",
      "And sentries sweated for the day was hot:",
      "A crowd of ordinary decent folk",
      "Watched from without and neither moved nor spoke",
      "As three pale figures were led forth and bound",
      "To three posts driven upright in the ground."
    ]},
    { type: "scene", lines: [
      "The mass and majesty of this world, all",
      "That carries weight and always weighs the same",
      "Lay in the hands of others; they were small",
      "And could not hope for help and no help came:",
      "What their foes liked to do was done, their shame",
      "Was all the worst could wish; they lost their pride",
      "And died as men before their bodies died."
    ]},
    { type: "thetis", lines: [
      "She looked over his shoulder",
      "For athletes at their games,",
      "Men and women in a dance",
      "Moving their sweet limbs",
      "Quick, quick, to music,",
      "But there on the shining shield",
      "His hands had set no dancing-floor",
      "But a weed-choked field."
    ]},
    { type: "scene", lines: [
      "A ragged urchin, aimless and alone,",
      "Loitered about that vacancy; a bird",
      "Flew up to safety from his well-aimed stone:",
      "That girls are raped, that two boys knife a third,",
      "Were axioms to him, who'd never heard",
      "Of any world where promises were kept,",
      "Or one could weep because another wept."
    ]},
    { type: "coda", lines: [
      "The thin-lipped armorer,",
      "Hephaestos, hobbled away,",
      "Thetis of the shining breasts",
      "Cried out in dismay",
      "At what the god had wrought",
      "To please her son, the strong",
      "Iron-hearted man-slaying Achilles",
      "Who would not live long."
    ]}
  ]
};

const ZONES = [
  { id: "THETIS", y: [0,2], material: "STONE", weight: "BOLD", stanzaTypes: ["thetis"] },
  { id: "WILDERNESS", y: [3,5], material: "DUST", weight: "LIGHT", stanzaTypes: ["scene"] },
  { id: "MULTITUDE", y: [6,8], material: "LEAD", weight: "REGULAR", stanzaTypes: ["scene"] },
  { id: "VOICE", y: [9,11], material: "ASH", weight: "HAIRLINE", stanzaTypes: ["scene"] },
  { id: "ALTAR", y: [12,14], material: "BLOOD", weight: "BOLD", stanzaTypes: ["thetis","scene"] },
  { id: "CAMP", y: [15,17], material: "IRON", weight: "REGULAR", stanzaTypes: ["scene"] },
  { id: "FIELD", y: [18,20], material: "DUST", weight: "LIGHT", stanzaTypes: ["scene"] },
  { id: "FORGE", y: [21,23], material: "IRON", weight: "BLACK", stanzaTypes: ["coda"] }
];

const W = 24, H = 24;
let cells = [];
const gridEl = document.getElementById("grid");

function mulberry32(seed) {
  let a = seed >>> 0;
  return function() {
    a += 0x6D2B79F5;
    let t = Math.imul(a ^ (a >>> 15), 1 | a);
    t ^= t + Math.imul(t ^ (t >>> 7), 61 | t);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}

function tokenize(text) {
  return text.split('');
}

function getZone(y) {
  for (const z of ZONES) {
    if (y >= z.y[0] && y <= z.y[1]) return z;
  }
  return ZONES[0];
}

function getAllText() {
  let chars = [];
  for (const stanza of POEM.stanzas) {
    for (const line of stanza.lines) {
      chars.push(...tokenize(line));
      chars.push(' ');
    }
    chars.push('⁂');
  }
  return chars;
}

function shieldMask(x, y) {
  const cx = 11.5, cy = 11.5;
  const dx = x - cx, dy = y - cy;
  const r = Math.sqrt(dx*dx + dy*dy);
  return r <= 11.5;
}

function buildGrid(seed) {
  const rand = mulberry32(seed);
  cells = [];
  const allChars = getAllText();
  let charIdx = 0;
  
  for (let y = 0; y < H; y++) {
    for (let x = 0; x < W; x++) {
      const zone = getZone(y);
      const inShield = shieldMask(x, y);
      
      let text = '';
      let calligram = {
        glyph_flow: "LINEAR",
        stroke_weight: zone.weight,
        gravity: "CENTER",
        calligram_function: inShield ? "IMAGE" : "VOID",
        letter_material: zone.material
      };
      
      if (inShield && charIdx < allChars.length) {
        text = allChars[charIdx++];
        if (text === '⁂') {
          calligram.calligram_function = "BARRIER";
          calligram.stroke_weight = "BLACK";
        }
      }
      
      cells.push({
        x, y,
        zone_id: zone.id,
        text,
        calligram,
        inShield
      });
    }
  }
}

function render() {
  gridEl.innerHTML = '';
  for (const c of cells) {
    const el = document.createElement('div');
    el.className = 'cell';
    el.classList.add('z-' + c.zone_id);
    el.classList.add('w-' + c.calligram.stroke_weight);
    el.classList.add('g-' + c.calligram.gravity);
    el.classList.add('m-' + c.calligram.letter_material);
    el.classList.add('f-' + c.calligram.calligram_function);
    if (!c.inShield) el.classList.add('blank');
    el.textContent = c.text;
    el.dataset.x = c.x;
    el.dataset.y = c.y;
    el.addEventListener('click', () => showToast(c));
    gridEl.appendChild(el);
  }
}

function showToast(c) {
  const toast = document.getElementById('toast');
  document.getElementById('toastTitle').textContent = `Cell (${c.x}, ${c.y}) — Zone: ${c.zone_id}`;
  document.getElementById('toastBody').textContent = JSON.stringify(c, null, 2);
  toast.style.display = 'block';
}

document.getElementById('toastClose').addEventListener('click', () => {
  document.getElementById('toast').style.display = 'none';
});

document.getElementById('regenerate').addEventListener('click', () => {
  buildGrid(Date.now());
  render();
});

let traversing = false;
document.getElementById('traverse').addEventListener('click', async () => {
  if (traversing) return;
  traversing = true;
  
  document.querySelectorAll('.cell').forEach(el => el.classList.remove('highlight'));
  
  const shieldCells = cells.filter(c => c.inShield && c.text);
  for (let i = 0; i < shieldCells.length; i++) {
    const c = shieldCells[i];
    const el = gridEl.children[c.y * W + c.x];
    if (el) {
      el.classList.add('highlight');
      await new Promise(r => setTimeout(r, 15));
      el.classList.remove('highlight');
    }
  }
  
  traversing = false;
});

buildGrid(0xA0DE7);
render();
</script>
</body>
</html>
