<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>CAREY URN GRID ‚Äî Ritual Cartography</title>
  <style>
    :root{
      --bg: #f6f2e8;
      --paper: #fbf8f0;
      --ink: #111;
      --muted: rgba(17,17,17,.65);
      --hair: rgba(17,17,17,.14);
      --hair2: rgba(17,17,17,.08);

      --accent: #1b4b7a;
      --accent2: #8a3d1e; /* clay/orange */
      --good: #196a2a;
      --warn: #7a5b00;
      --bad: #8a1f1f;

      --chip: rgba(27,75,122,.10);
      --chip2: rgba(138,61,30,.10);

      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius: 16px;
      --radius2: 22px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--ink);
      background: radial-gradient(1200px 800px at 30% -10%, #fff 0%, var(--bg) 60%, #efe8d7 100%);
      overflow-x:hidden;
    }

    a{ color: inherit; text-decoration: none; }
    button, input, select { font: inherit; color: inherit; }
    button{ cursor:pointer; }

    /* Layout */
    .app{
      min-height: 100dvh;
      display:flex;
      flex-direction:column;
    }

    header{
      position: sticky;
      top: 0;
      z-index: 30;
      background: linear-gradient(to bottom, rgba(246,242,232,.96), rgba(246,242,232,.78));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--hair);
    }

    .topbar{
      display:flex;
      gap:12px;
      align-items: center;
      padding: 14px 14px 10px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .brand{
      display:flex;
      gap:10px;
      align-items:flex-start;
      min-width: 220px;
    }

    .sigil{
      width: 38px; height: 38px;
      border-radius: 14px;
      background:
        radial-gradient(10px 10px at 70% 30%, rgba(255,255,255,.9), rgba(255,255,255,0)),
        linear-gradient(135deg, rgba(27,75,122,.22), rgba(138,61,30,.20));
      border: 1px solid var(--hair);
      box-shadow: 0 6px 16px rgba(0,0,0,.08);
      flex: 0 0 auto;
      position: relative;
    }
    .sigil:after{
      content:"";
      position:absolute;
      inset:10px;
      border-radius: 12px;
      border: 1px dashed rgba(17,17,17,.20);
    }

    .brand h1{
      margin:0;
      font-size: 14px;
      line-height: 1.2;
      letter-spacing: .04em;
      text-transform: uppercase;
    }
    .brand .sub{
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
      line-height: 1.3;
    }

    .controls{
      flex: 1 1 auto;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content: flex-end;
      flex-wrap:wrap;
    }

    .search{
      flex: 1 1 260px;
      display:flex;
      gap:8px;
      align-items:center;
      padding: 10px 12px;
      border: 1px solid var(--hair);
      background: rgba(255,255,255,.65);
      border-radius: 999px;
      box-shadow: 0 6px 16px rgba(0,0,0,.04);
      max-width: 520px;
    }
    .search input{
      border:0;
      outline:none;
      background:transparent;
      width:100%;
      font-size: 14px;
    }
    .search .hint{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(17,17,17,.45);
      padding-left: 6px;
      border-left: 1px solid var(--hair2);
      white-space:nowrap;
    }

    .seg{
      display:flex;
      border: 1px solid var(--hair);
      border-radius: 999px;
      overflow:hidden;
      background: rgba(255,255,255,.55);
      box-shadow: 0 6px 16px rgba(0,0,0,.04);
    }
    .seg button{
      border:0;
      padding: 10px 12px;
      background: transparent;
      font-size: 13px;
      color: rgba(17,17,17,.72);
      display:flex;
      gap:8px;
      align-items:center;
    }
    .seg button[aria-pressed="true"]{
      background: rgba(27,75,122,.12);
      color: var(--ink);
    }

    .pillbtn{
      border: 1px solid var(--hair);
      background: rgba(255,255,255,.55);
      border-radius: 999px;
      padding: 10px 12px;
      font-size: 13px;
      box-shadow: 0 6px 16px rgba(0,0,0,.04);
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .pillbtn:active{ transform: translateY(1px); }

    /* Filter tray */
    .tray{
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 14px 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .group{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      padding: 8px 10px;
      border: 1px solid var(--hair);
      background: rgba(255,255,255,.55);
      border-radius: 999px;
      box-shadow: 0 6px 16px rgba(0,0,0,.03);
    }
    .group .label{
      font-size: 12px;
      color: var(--muted);
      letter-spacing:.02em;
      padding-right: 6px;
      border-right: 1px solid var(--hair2);
    }

    .chip{
      border: 1px solid var(--hair);
      background: var(--chip);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      display:flex;
      gap:8px;
      align-items:center;
      user-select:none;
    }
    .chip[data-on="true"]{
      background: rgba(27,75,122,.18);
      border-color: rgba(27,75,122,.35);
    }
    .chip small{
      font-family: var(--mono);
      font-size: 10px;
      color: rgba(17,17,17,.58);
    }

    .chip.proc{
      background: var(--chip2);
    }
    .chip.proc[data-on="true"]{
      background: rgba(138,61,30,.18);
      border-color: rgba(138,61,30,.35);
    }

    /* Main */
    main{
      flex: 1 1 auto;
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
      padding: 14px 14px 96px; /* leave room for bottom nav on mobile */
    }

    .panel{
      background: rgba(255,255,255,.62);
      border: 1px solid var(--hair);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .panel .head{
      padding: 12px 14px;
      border-bottom: 1px solid var(--hair);
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      background: linear-gradient(to bottom, rgba(255,255,255,.7), rgba(255,255,255,.55));
    }
    .panel .head h2{
      margin:0;
      font-size: 14px;
      letter-spacing:.02em;
      text-transform: uppercase;
    }
    .panel .head .sub{
      margin-top: 2px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.3;
      max-width: 60ch;
    }

    .panel .head .actions{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .tinybtn{
      border: 1px solid var(--hair);
      background: rgba(255,255,255,.62);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      display:flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }

    /* Grid mode */
    .gridwrap{
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }

    .chapelgrid{
      display:grid;
      grid-template-columns: repeat(5, minmax(240px, 1fr));
      gap: 12px;
      padding: 12px;
      min-width: 1100px; /* horizontal scroll on small screens */
    }

    .chapel{
      border: 1px solid var(--hair);
      border-radius: var(--radius);
      background: rgba(251,248,240,.68);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 560px;
    }

    .chapel header{
      position: static;
      background: transparent;
      backdrop-filter:none;
      border: 0;
    }

    .chapel .ch-head{
      padding: 12px 12px 10px;
      border-bottom: 1px solid var(--hair);
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .ch-title{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
    }
    .ch-title strong{
      font-size: 13px;
      letter-spacing:.03em;
      text-transform: uppercase;
    }
    .ch-title span{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(17,17,17,.55);
      white-space:nowrap;
    }

    .ch-diagram{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }
    .ch-diagram b{ color: rgba(17,17,17,.78); font-weight: 600; }

    .lines{
      padding: 10px;
      display:grid;
      grid-template-rows: repeat(10, minmax(48px, auto));
      gap: 8px;
      flex: 1 1 auto;
    }

    .cell{
      border: 1px solid var(--hair);
      background: rgba(255,255,255,.65);
      border-radius: 14px;
      padding: 10px 10px 8px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      box-shadow: 0 6px 16px rgba(0,0,0,.04);
      transition: transform .08s ease, opacity .12s ease, background .12s ease;
    }
    .cell:active{ transform: translateY(1px); }
    .cell[data-dim="true"]{ opacity:.30; }
    .cell[data-hide="true"]{ display:none; }

    .lid{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(17,17,17,.65);
      min-width: 64px;
      line-height: 1.25;
    }
    .lid .fn{
      display:inline-block;
      margin-top: 4px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--hair);
      background: rgba(27,75,122,.08);
      font-size: 10px;
      letter-spacing: .02em;
    }
    .lid .fn[data-fn="PRODUCE"]{ background: rgba(25,106,42,.10); border-color: rgba(25,106,42,.22); }
    .lid .fn[data-fn="MAINTAIN"]{ background: rgba(27,75,122,.10); border-color: rgba(27,75,122,.22); }
    .lid .fn[data-fn="REPAIR"]{ background: rgba(138,31,31,.10); border-color: rgba(138,31,31,.22); }
    .lid .fn[data-fn="TRANSFORM"]{ background: rgba(122,91,0,.12); border-color: rgba(122,91,0,.22); }

    .ctext{
      flex: 1 1 auto;
      min-width: 0;
    }
    .ctext .line{
      font-size: 13px;
      line-height: 1.25;
      margin:0;
      display:-webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow:hidden;
    }
    .badges{
      margin-top: 6px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
    }
    .badge{
      font-size: 11px;
      border: 1px solid var(--hair);
      background: rgba(255,255,255,.65);
      border-radius: 999px;
      padding: 2px 8px;
      color: rgba(17,17,17,.70);
      white-space:nowrap;
    }
    .badge.altar{ background: rgba(27,75,122,.08); }
    .badge.proc{ background: rgba(138,61,30,.08); }

    /* Cards mode */
    .cards{
      padding: 12px;
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
    }
    .cards .left{
      grid-column: span 4;
      min-width: 0;
    }
    .cards .right{
      grid-column: span 8;
      min-width: 0;
    }

    .box{
      border: 1px solid var(--hair);
      background: rgba(255,255,255,.62);
      border-radius: var(--radius2);
      padding: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,.04);
    }

    .box h3{
      margin:0 0 8px;
      font-size: 13px;
      letter-spacing:.03em;
      text-transform: uppercase;
    }
    .box p{
      margin: 8px 0 0;
      font-size: 12px;
      color: var(--muted);
      line-height:1.4;
    }

    .selectrow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 8px;
    }
    select{
      border: 1px solid var(--hair);
      background: rgba(251,248,240,.70);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      min-width: 200px;
      outline:none;
    }

    .cardstage{
      border: 1px dashed rgba(17,17,17,.20);
      border-radius: var(--radius2);
      min-height: 360px;
      background: rgba(251,248,240,.60);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 14px;
      position:relative;
      overflow:hidden;
    }
    .card{
      width: min(520px, 100%);
      border-radius: 22px;
      background: rgba(255,255,255,.82);
      border: 1px solid var(--hair);
      box-shadow: 0 16px 40px rgba(0,0,0,.10);
      padding: 14px 14px 12px;
      transform-style: preserve-3d;
      transition: transform .35s cubic-bezier(.2,.9,.2,1);
      position: relative;
    }
    .card[data-face="back"]{ transform: rotateY(180deg); }

    .face{
      backface-visibility: hidden;
      position:absolute;
      inset:0;
      padding: 14px 14px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .face.back{ transform: rotateY(180deg); }

    .card .meta{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .card .meta .id{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(17,17,17,.72);
    }
    .card .meta .fn{
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--hair);
      background: rgba(27,75,122,.10);
      letter-spacing:.03em;
    }
    .card .meta .fn[data-fn="PRODUCE"]{ background: rgba(25,106,42,.10); border-color: rgba(25,106,42,.22); }
    .card .meta .fn[data-fn="MAINTAIN"]{ background: rgba(27,75,122,.10); border-color: rgba(27,75,122,.22); }
    .card .meta .fn[data-fn="REPAIR"]{ background: rgba(138,31,31,.10); border-color: rgba(138,31,31,.22); }
    .card .meta .fn[data-fn="TRANSFORM"]{ background: rgba(122,91,0,.12); border-color: rgba(122,91,0,.22); }

    .card .bigline{
      margin: 0;
      font-size: 18px;
      line-height: 1.28;
      letter-spacing: .01em;
    }
    .card .small{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.45;
    }
    .kv{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:8px 12px;
      font-size: 12px;
      line-height:1.35;
      color: rgba(17,17,17,.80);
    }
    .k{ color: rgba(17,17,17,.55); font-family: var(--mono); font-size: 11px; }
    .v{ color: rgba(17,17,17,.82); }

    .decknav{
      margin-top: 10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .decknav .leftbtns, .decknav .rightbtns{
      display:flex; gap:8px; flex-wrap:wrap;
    }

    /* Mass mode */
    .mass{
      padding: 12px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 12px;
    }

    .script{
      border: 1px solid var(--hair);
      border-radius: var(--radius2);
      background: rgba(251,248,240,.64);
      overflow:hidden;
    }
    .script header{
      position: static;
      background: transparent;
      border:0;
    }
    .script .shead{
      padding: 12px 12px 10px;
      border-bottom: 1px solid var(--hair);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .script .shead h3{
      margin:0;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing:.03em;
    }
    .script .shead .sub{
      margin-top: 2px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
      max-width: 60ch;
    }
    .script .body{
      padding: 10px 12px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    details{
      border: 1px solid var(--hair);
      border-radius: 16px;
      background: rgba(255,255,255,.65);
      padding: 10px 10px 8px;
    }
    summary{
      cursor:pointer;
      font-size: 12px;
      color: rgba(17,17,17,.78);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      list-style:none;
    }
    summary::-webkit-details-marker{ display:none; }
    .count{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(17,17,17,.55);
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--hair);
      background: rgba(27,75,122,.08);
    }

    .scriptlist{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .sline{
      border: 1px solid var(--hair);
      background: rgba(251,248,240,.72);
      border-radius: 14px;
      padding: 10px;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .sline .tag{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(17,17,17,.62);
      min-width: 70px;
    }
    .sline p{
      margin:0;
      font-size: 13px;
      line-height: 1.25;
    }

    .player{
      border: 1px solid var(--hair);
      border-radius: var(--radius2);
      background: rgba(255,255,255,.62);
      box-shadow: 0 6px 18px rgba(0,0,0,.04);
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .player h3{
      margin:0;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing:.03em;
    }
    .now{
      border: 1px dashed rgba(17,17,17,.20);
      border-radius: 18px;
      background: rgba(251,248,240,.64);
      padding: 12px;
      min-height: 140px;
    }
    .now .who{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(17,17,17,.62);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .now .who b{
      color: rgba(17,17,17,.80);
      font-family: var(--sans);
      font-size: 12px;
      letter-spacing:.02em;
      text-transform: uppercase;
    }
    .now .text{
      margin-top: 8px;
      font-size: 16px;
      line-height: 1.28;
    }
    .now .note{
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    .row{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    }
    .row .grow{ flex: 1 1 auto; }

    /* Modal */
    dialog{
      width: min(860px, calc(100% - 24px));
      border: 1px solid var(--hair);
      border-radius: 22px;
      padding: 0;
      box-shadow: 0 18px 60px rgba(0,0,0,.22);
      background: rgba(251,248,240,.98);
      color: var(--ink);
    }
    dialog::backdrop{
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(4px);
    }
    .modalhead{
      padding: 12px 14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid var(--hair);
      background: linear-gradient(to bottom, rgba(255,255,255,.8), rgba(251,248,240,.92));
    }
    .modalhead .left{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .modalhead .left .id{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(17,17,17,.68);
    }
    .modalhead .left h3{
      margin:0;
      font-size: 14px;
      letter-spacing:.02em;
      text-transform: uppercase;
    }
    .modalhead .right{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .modalbody{
      padding: 12px 14px 14px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 12px;
    }
    .quote{
      border: 1px solid var(--hair);
      border-radius: 18px;
      background: rgba(255,255,255,.65);
      padding: 12px;
    }
    .quote p{
      margin:0;
      font-size: 18px;
      line-height: 1.35;
    }
    .quote .meta{
      margin-top: 10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .quote .meta .mini{
      font-size: 11px;
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid var(--hair);
      background: rgba(27,75,122,.08);
      white-space:nowrap;
    }

    .detail{
      border: 1px solid var(--hair);
      border-radius: 18px;
      background: rgba(255,255,255,.62);
      padding: 12px;
    }
    .detail h4{
      margin:0 0 8px;
      font-size: 12px;
      letter-spacing:.03em;
      text-transform: uppercase;
      color: rgba(17,17,17,.78);
    }
    .detail .p{
      margin: 0 0 10px;
      font-size: 13px;
      color: rgba(17,17,17,.82);
      line-height: 1.45;
    }
    .detail .p.muted{ color: var(--muted); }
    .detail .tags{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top: 8px;
    }

    /* Bottom nav for mobile */
    .bottomnav{
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 40;
      background: linear-gradient(to top, rgba(246,242,232,.96), rgba(246,242,232,.70));
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--hair);
      padding: 8px 10px calc(10px + env(safe-area-inset-bottom));
      display:none;
    }
    .bottomnav .bar{
      max-width: 1200px;
      margin: 0 auto;
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
    }
    .bbtn{
      flex: 1 1 0;
      border: 1px solid var(--hair);
      background: rgba(255,255,255,.62);
      border-radius: 16px;
      padding: 10px 10px;
      font-size: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .bbtn[data-on="true"]{
      background: rgba(27,75,122,.12);
      border-color: rgba(27,75,122,.28);
    }

    /* Responsive */
    @media (max-width: 980px){
      .cards{ grid-template-columns: 1fr; }
      .cards .left{ grid-column: span 12; }
      .cards .right{ grid-column: span 12; }
      .mass{ grid-template-columns: 1fr; }
      .brand{ min-width: unset; }
    }

    @media (max-width: 760px){
      .topbar{ padding: 12px 12px 8px; }
      .tray{ padding: 0 12px 10px; }
      main{ padding: 12px 12px 106px; }
      .seg{ display:none; }
      .bottomnav{ display:block; }
      .search .hint{ display:none; }
      .modalbody{ grid-template-columns: 1fr; }
    }

    /* Utility */
    .hide{ display:none !important; }
    .muted{ color: var(--muted); }
    .mono{ font-family: var(--mono); }
  </style>
</head>

<body>
<div class="app">
  <header>
    <div class="topbar">
      <div class="brand" role="banner">
        <div class="sigil" aria-hidden="true"></div>
        <div>
          <h1>CAREY URN GRID</h1>
          <div class="sub">Ritual cartography: map-of + map-for (Keats as ceremony; urn as staging device)</div>
        </div>
      </div>

      <div class="controls" role="region" aria-label="Primary controls">
        <div class="search" role="search">
          <span class="mono" aria-hidden="true">‚åï</span>
          <input id="q" type="text" placeholder="Search line text, rite action, world effect, or ID (e.g., URN-L17)‚Ä¶" />
          <span class="hint">Enter</span>
        </div>

        <div class="seg" role="tablist" aria-label="View mode">
          <button id="tabGrid" role="tab" aria-selected="true" aria-pressed="true">‚ñ¶ Grid</button>
          <button id="tabCards" role="tab" aria-selected="false" aria-pressed="false">üÇ† Cards</button>
          <button id="tabMass" role="tab" aria-selected="false" aria-pressed="false">‚õ™ Mass</button>
        </div>

        <button class="pillbtn" id="btnReset" title="Clear filters, search, and restore default ordering">
          ‚Ü∫ Reset
        </button>

        <button class="pillbtn" id="btnExport" title="Copy current (filtered) dataset to clipboard as JSON">
          ‚ßâ Copy JSON
        </button>
      </div>
    </div>

    <div class="tray" role="region" aria-label="Filter tray">
      <div class="group" aria-label="Altars filter">
        <div class="label">ALTARS</div>
        <div class="chip" data-altar="A_SILENCE" role="button" tabindex="0" aria-pressed="false">Silence/Unheard <small>A_SILENCE</small></div>
        <div class="chip" data-altar="A_TIME" role="button" tabindex="0" aria-pressed="false">Time/Forever <small>A_TIME</small></div>
        <div class="chip" data-altar="A_DESIRE" role="button" tabindex="0" aria-pressed="false">Desire/Nearness <small>A_DESIRE</small></div>
        <div class="chip" data-altar="A_COMMUNITY" role="button" tabindex="0" aria-pressed="false">Community/Town <small>A_COMMUNITY</small></div>
        <div class="chip" data-altar="A_TRUTH" role="button" tabindex="0" aria-pressed="false">Truth/Beauty <small>A_TRUTH</small></div>
      </div>

      <div class="group" aria-label="Processions filter">
        <div class="label">PROCESSIONS</div>
        <div class="chip proc" data-proc="PR_APOS" role="button" tabindex="0" aria-pressed="false">Apostrophe <small>PR_APOS</small></div>
        <div class="chip proc" data-proc="PR_Q" role="button" tabindex="0" aria-pressed="false">Questions <small>PR_Q</small></div>
        <div class="chip proc" data-proc="PR_FOREVER" role="button" tabindex="0" aria-pressed="false">Forever chant <small>PR_FOREVER</small></div>
      </div>

      <div class="group" aria-label="Display options">
        <div class="label">DISPLAY</div>
        <div class="chip" id="chipHide" role="button" tabindex="0" aria-pressed="false">Hide non-matching</div>
        <div class="chip" id="chipAuto" role="button" tabindex="0" aria-pressed="true" data-on="true">Auto-detect processions</div>
      </div>
    </div>
  </header>

  <main>
    <!-- GRID -->
    <section id="viewGrid" class="panel" aria-label="Chapel Grid view">
      <div class="head">
        <div>
          <h2>Chapel Grid</h2>
          <div class="sub">
            5 columns = chapels (stanzas). 10 rows = line order. Vertical = time procession; horizontal = altar resonance.
            Tap any cell to open the rite-unit (what the line <i>does</i> to shared order).
          </div>
        </div>
        <div class="actions">
          <button class="tinybtn" id="btnFocusAltars" title="Highlight altar tags in each cell">‚ú∂ Highlight tags</button>
          <button class="tinybtn" id="btnOpenRepair" title="Open repair logic notes">‚öï Repair logic</button>
        </div>
      </div>
      <div class="gridwrap">
        <div id="chapelGrid" class="chapelgrid" aria-label="Grid"></div>
      </div>
    </section>

    <!-- CARDS -->
    <section id="viewCards" class="panel hide" aria-label="Ritual Cards view">
      <div class="head">
        <div>
          <h2>Ritual Cards</h2>
          <div class="sub">
            Each line is a card: FRONT = line text. BACK = rite action + function + altars + continuity hook.
            Shuffle within chapel to re-enact ritual variation while keeping chapel seals intact.
          </div>
        </div>
        <div class="actions">
          <button class="tinybtn" id="btnFlip">‚Üª Flip</button>
          <button class="tinybtn" id="btnPrev">‚Üê Prev</button>
          <button class="tinybtn" id="btnNext">Next ‚Üí</button>
        </div>
      </div>

      <div class="cards">
        <div class="left">
          <div class="box">
            <h3>Deck controls</h3>
            <div class="selectrow">
              <select id="deckChapel" aria-label="Choose chapel">
                <option value="ALL">All chapels</option>
                <option value="1">C1 ‚Äî Invocation + Interrogation</option>
                <option value="2">C2 ‚Äî Unheard Music + Suspended Kiss</option>
                <option value="3">C3 ‚Äî Eternal Spring + Saturation</option>
                <option value="4">C4 ‚Äî Sacrifice + Empty Town</option>
                <option value="5">C5 ‚Äî Attic Shape + Aphorism Seal</option>
              </select>
              <button class="tinybtn" id="btnShuffle">‚ü≤ Shuffle</button>
              <button class="tinybtn" id="btnResetDeck">‚Ü∫ Reset deck</button>
            </div>
            <p>
              Tip: use filters above (altars/processions) to carve a ‚Äúmicro-mass‚Äù deck, then shuffle and read.
            </p>
          </div>

          <div class="box" style="margin-top:12px;">
            <h3>Chapel seals</h3>
            <p class="muted">These are the ‚Äúclosing lines‚Äù that stabilize time-order in each chapel.</p>
            <div id="sealList" class="scriptlist" style="margin-top:10px;"></div>
          </div>
        </div>

        <div class="right">
          <div class="cardstage" aria-label="Card stage">
            <div id="card" class="card" data-face="front" role="button" tabindex="0" aria-label="Card (tap to flip)">
              <div class="face front">
                <div class="meta">
                  <div class="id mono" id="cardId">URN-L01</div>
                  <div class="fn mono" id="cardFn" data-fn="PRODUCE">PRODUCE</div>
                </div>
                <p class="bigline" id="cardText"></p>
                <div class="badges" id="cardBadges"></div>
                <div class="small muted">Tap to flip. Use Prev/Next to step. Filters apply to the deck.</div>
              </div>

              <div class="face back">
                <div class="meta">
                  <div class="id mono" id="cardIdB">URN-L01</div>
                  <div class="fn mono" id="cardFnB" data-fn="PRODUCE">PRODUCE</div>
                </div>
                <div class="kv">
                  <div class="k">RITE ACTION</div><div class="v" id="cardAction"></div>
                  <div class="k">WORLD EFFECT</div><div class="v" id="cardEffect"></div>
                  <div class="k">HOOK ‚Üí</div><div class="v" id="cardHook"></div>
                </div>
                <div class="badges" id="cardBadgesB" style="margin-top:10px;"></div>
                <div class="small muted">Tap to flip back. Click a badge above to filter.</div>
              </div>
            </div>
          </div>

          <div class="decknav">
            <div class="leftbtns">
              <button class="tinybtn" id="btnOpenCurrent">‚Üó Open details</button>
              <button class="tinybtn" id="btnCopyCurrent">‚ßâ Copy line JSON</button>
            </div>
            <div class="rightbtns">
              <span class="mono muted" id="deckCount">1 / 50</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- MASS -->
    <section id="viewMass" class="panel hide" aria-label="Mass Reading view">
      <div class="head">
        <div>
          <h2>Mass Reading</h2>
          <div class="sub">
            CALL (apostrophes) ‚Üí RESPONSE (questions) ‚Üí CHANT (forever/happy/never) ‚Üí BENEDICTION (Beauty/Truth).
            This makes reading a social script ‚Äî a ritual that produces and repairs shared order.
          </div>
        </div>
        <div class="actions">
          <button class="tinybtn" id="btnStartMass">‚ñ∂ Start</button>
          <button class="tinybtn" id="btnStepPrev">‚Üê Back</button>
          <button class="tinybtn" id="btnStepNext">Next ‚Üí</button>
        </div>
      </div>

      <div class="mass">
        <div class="script" aria-label="Mass script">
          <div class="shead">
            <div>
              <h3>Script</h3>
              <div class="sub">Lists are live: your filters above re-shape the liturgy (the map changes the world it describes).</div>
            </div>
            <div class="actions">
              <button class="tinybtn" id="btnExpandAll">‚ñæ Expand all</button>
              <button class="tinybtn" id="btnCollapseAll">‚ñ∏ Collapse all</button>
            </div>
          </div>

          <div class="body">
            <details id="secCall" open>
              <summary>CALL <span class="count" id="countCall">0</span></summary>
              <div id="listCall" class="scriptlist"></div>
            </details>

            <details id="secResp" open>
              <summary>RESPONSE <span class="count" id="countResp">0</span></summary>
              <div id="listResp" class="scriptlist"></div>
            </details>

            <details id="secChant" open>
              <summary>CHANT <span class="count" id="countChant">0</span></summary>
              <div id="listChant" class="scriptlist"></div>
            </details>

            <details id="secBened" open>
              <summary>BENEDICTION <span class="count" id="countBened">0</span></summary>
              <div id="listBened" class="scriptlist"></div>
            </details>
          </div>
        </div>

        <div class="player" aria-label="Guided reading player">
          <h3>Guided traversal</h3>

          <div class="now" id="now">
            <div class="who">
              <div><b id="nowRole">CALL</b> <span class="muted mono" id="nowId">URN-L01</span></div>
              <div class="muted mono" id="nowIdx">1 / 50</div>
            </div>
            <div class="text" id="nowText">Press Start to begin the ritual traversal.</div>
            <div class="note" id="nowNote">Tip: click any line in the script to jump the player there.</div>
          </div>

          <div class="row">
            <button class="tinybtn" id="btnJumpOpen">‚Üó Open details</button>
            <button class="tinybtn" id="btnJumpCopy">‚ßâ Copy line</button>
            <span class="grow"></span>
            <button class="tinybtn" id="btnJumpGrid">‚ñ¶ Jump to grid</button>
          </div>

          <div class="box">
            <h3>Repair logic (breakpoints)</h3>
            <p>
              The rite ‚Äúbreaks‚Äù at suspended desire (L17‚ÄìL20), human saturation (L29‚ÄìL30),
              testimony collapse (L39‚ÄìL40), and ambivalence (‚ÄúCold Pastoral!‚Äù, L45).
              Filters can isolate these breaks ‚Äî then re-run the seal (L49‚ÄìL50).
            </p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Bottom nav (mobile) -->
  <div class="bottomnav" aria-label="Bottom navigation">
    <div class="bar">
      <button class="bbtn" id="bGrid" data-on="true">‚ñ¶ Grid</button>
      <button class="bbtn" id="bCards" data-on="false">üÇ† Cards</button>
      <button class="bbtn" id="bMass" data-on="false">‚õ™ Mass</button>
      <button class="bbtn" id="bFilters" data-on="false">‚ú∂ Filters</button>
    </div>
  </div>

  <!-- Modal -->
  <dialog id="dlg">
    <div class="modalhead">
      <div class="left">
        <div class="id" id="dlgId">URN-L01</div>
        <h3 id="dlgTitle">Rite Unit</h3>
      </div>
      <div class="right">
        <button class="tinybtn" id="dlgPrev">‚Üê Prev</button>
        <button class="tinybtn" id="dlgNext">Next ‚Üí</button>
        <button class="tinybtn" id="dlgCopy">‚ßâ Copy</button>
        <button class="tinybtn" id="dlgClose">‚úï Close</button>
      </div>
    </div>

    <div class="modalbody">
      <div class="quote">
        <p id="dlgText"></p>
        <div class="meta" id="dlgMeta"></div>
      </div>

      <div class="detail">
        <h4>Rite action</h4>
        <p class="p" id="dlgAction"></p>

        <h4>World effect</h4>
        <p class="p" id="dlgEffect"></p>

        <h4>Continuity hook</h4>
        <p class="p muted" id="dlgHook"></p>

        <div class="tags" id="dlgTags"></div>
      </div>
    </div>
  </dialog>
</div>

<script>
/* ============================================================
   CAREY URN GRID ‚Äî Single-file renderer (no external deps)
   ============================================================ */

const DATA = {
  prompt_id: "CAREY-URN-GRID-v1",
  title: "Ode on a Grecian Urn ‚Äî Ritual Map",
  altars: [
    {id:"A_SILENCE", name:"Silence/Unheard"},
    {id:"A_TIME", name:"Time/Forever"},
    {id:"A_DESIRE", name:"Desire/Nearness"},
    {id:"A_COMMUNITY", name:"Town/People/Shared Life"},
    {id:"A_TRUTH", name:"Beauty/Truth Formula"}
  ],
  chapels: [
    {
      id:"C1", stanza:1, name:"Invocation + Interrogation", lines:"1‚Äì10",
      diagram:{
        ENTRY:"Apostrophe consecrates Urn-as-Stage; stillness becomes presence.",
        CHANT:"Question-procession piles interrogatives; wonder becomes shared order.",
        TURN:"Desire/drama appears but is held inside marble time.",
        SEAL:"Instruments imply music; absence becomes bond."
      }
    },
    {
      id:"C2", stanza:2, name:"Unheard Music + Suspended Kiss", lines:"11‚Äì20",
      diagram:{
        ENTRY:"Heard/unheard inversion reassigns authority from senses to shared inwardness.",
        CHANT:"Commands to pipes (‚Äòplay on‚Äô) keep the rite running.",
        TURN:"The kiss cannot occur; deprivation becomes permanence.",
        SEAL:"‚ÄòFor ever‚Äô chant stabilizes love and beauty against time."
      }
    },
    {
      id:"C3", stanza:3, name:"Eternal Spring + Saturation", lines:"21‚Äì30",
      diagram:{
        ENTRY:"‚ÄòHappy‚Äô repetition manufactures communal mood as liturgy.",
        CHANT:"Forever-procession loops newness through repetition.",
        TURN:"Human passion‚Äôs cost is named (cloy‚Äôd, sorrowful).",
        SEAL:"Embodied limit (burning/parching) restores credibility and need for stillness."
      }
    },
    {
      id:"C4", stanza:4, name:"Sacrifice + Empty Town", lines:"31‚Äì40",
      diagram:{
        ENTRY:"Procession-to-sacrifice makes society visible as action.",
        CHANT:"Apostrophe appoints priest/altar; offices and stations stabilize order.",
        TURN:"The emptied town converts community into absence-in-time.",
        SEAL:"Silence replaces testimony; readers inherit the duty to ‚Äòtell‚Äô."
      }
    },
    {
      id:"C5", stanza:5, name:"Attic Shape + Aphorism Seal", lines:"41‚Äì50",
      diagram:{
        ENTRY:"Praise consecrates form as container of shared world.",
        CHANT:"Silent form ‚Äòteases‚Äô cognition; wonder becomes method.",
        TURN:"‚ÄòCold Pastoral!‚Äô admits ambivalence inside the rite.",
        SEAL:"Aphorism binds beauty/truth and sets limits: communal ‚Äòenough‚Äô."
      }
    }
  ],
  rite_lines: [
    {"line_id":"URN-L01","stanza":1,"text":"Thou still unravish'd bride of quietness,","rite_action":"Consecrates the urn by direct address, turning reading into communion rather than observation.","reader_role":["Pilgrim"],"function":"PRODUCE","altars":["A_SILENCE","A_TIME"],"world_effect":"Creates a shared space where stillness counts as presence and intimacy can be non-consummated yet binding.","continuity_hook":"Opens the apostrophe channel that will carry the stanza‚Äôs interrogations."},
    {"line_id":"URN-L02","stanza":1,"text":"Thou foster-child of silence and slow time,","rite_action":"Installs silence and slow time as the governing liturgy‚Äîrules of tempo for the whole ceremony.","reader_role":["Witness"],"function":"MAINTAIN","altars":["A_SILENCE","A_TIME"],"world_effect":"Stabilizes an order where suspension is not decay but a shared discipline of attention.","continuity_hook":"Hands forward the urn‚Äôs kinship with time so ‚Äúhistorian‚Äù can become credible."},
    {"line_id":"URN-L03","stanza":1,"text":"Sylvan historian, who canst thus express","rite_action":"Appoints the urn to an office of communal memory, making the artifact a public historian.","reader_role":["Archivist"],"function":"PRODUCE","altars":["A_COMMUNITY","A_TIME"],"world_effect":"Legitimizes a memory-world that does not require living witnesses to stay real.","continuity_hook":"Promises an ‚Äòexpression‚Äô that will outrank ordinary speech."},
    {"line_id":"URN-L04","stanza":1,"text":"A flowery tale more sweetly than our rhyme:","rite_action":"Transfers authority from the poet‚Äôs voice to the urn‚Äôs form‚Äîmedium becomes the trusted priest.","reader_role":["Judge"],"function":"TRANSFORM","altars":["A_TRUTH","A_TIME"],"world_effect":"Reorders trust: durability and shape become the grounds of shared belief.","continuity_hook":"Launches the hunt: if the urn speaks ‚Äòsweeter,‚Äô what legend is it holding?"},
    {"line_id":"URN-L05","stanza":1,"text":"What leaf-fring'd legend haunts about thy shape","rite_action":"Initiates the question-procession, framing uncertainty as communal wonder rather than failure to decode.","reader_role":["Pilgrim","Witness"],"function":"PRODUCE","altars":["A_COMMUNITY","A_DESIRE"],"world_effect":"Creates a participatory world of partial evidence that demands shared inference.","continuity_hook":"Queues the cast-list to stabilize imagination (gods/mortals)."},
    {"line_id":"URN-L06","stanza":1,"text":"Of deities or mortals, or of both,","rite_action":"Performs ritual taxonomy: classifies beings so the scene becomes socially legible.","reader_role":["Archivist","Judge"],"function":"MAINTAIN","altars":["A_COMMUNITY","A_TRUTH"],"world_effect":"Maintains an ordered cosmos where categories hold even when facts are missing.","continuity_hook":"Anchors the rite in shared coordinates: named places as communal reference points."},
    {"line_id":"URN-L07","stanza":1,"text":"In Tempe or the dales of Arcady?","rite_action":"Maps the ceremony onto mythic geography‚Äî‚Äòthere‚Äô becomes a communal ‚Äòhere‚Äô for the reader-body.","reader_role":["Pilgrim"],"function":"PRODUCE","altars":["A_COMMUNITY","A_TIME"],"world_effect":"Produces place as a shared cultural instrument, not a location to verify.","continuity_hook":"Escalates from place to identity: who is here, in this shared scene?"},
    {"line_id":"URN-L08","stanza":1,"text":"What men or gods are these? What maidens loth?","rite_action":"Deepens the question-procession, binding the congregation through synchronized not-knowing.","reader_role":["Witness","Judge"],"function":"REPAIR","altars":["A_COMMUNITY","A_DESIRE"],"world_effect":"Repairs the reader‚Äôs need for certainty by sanctifying ambiguity as shared participation.","continuity_hook":"Introduces desire-with-resistance (‚Äòloth‚Äô) to power the next dramatic engine."},
    {"line_id":"URN-L09","stanza":1,"text":"What mad pursuit? What struggle to escape?","rite_action":"Stages conflict as the ritual engine‚Äîpursuit/escape becomes the world‚Äôs pulse under stillness.","reader_role":["Lover","Witness"],"function":"PRODUCE","altars":["A_DESIRE","A_TIME"],"world_effect":"Makes tension feel inevitable and communal: drama persists even when time is fixed.","continuity_hook":"Shifts from bodies to instruments, preparing the ‚Äòunheard‚Äô doctrine."},
    {"line_id":"URN-L10","stanza":1,"text":"What pipes and timbrels? What wild ecstasy?","rite_action":"Consecrates sound-objects that imply music without delivering it, priming shared imagination as liturgy.","reader_role":["Listener","Witness"],"function":"MAINTAIN","altars":["A_SILENCE","A_DESIRE"],"world_effect":"Maintains a world where absence (unheard music) is an active bond among readers.","continuity_hook":"Hands off to Chapel 2‚Äôs inversion: unheard becomes sweeter than heard."},

    {"line_id":"URN-L11","stanza":2,"text":"Heard melodies are sweet, but those unheard","rite_action":"Inverts sensory authority, teaching the congregation that shared interior hearing outranks public sound.","reader_role":["Judge","Listener"],"function":"TRANSFORM","altars":["A_SILENCE","A_TRUTH"],"world_effect":"Rebuilds what counts as ‚Äòreal‚Äô experience: the communal world is maintained through imagined audition.","continuity_hook":"Suspends the clause mid-gesture so the next line seals the preference."},
    {"line_id":"URN-L12","stanza":2,"text":"Are sweeter; therefore, ye soft pipes, play on;","rite_action":"Turns the instruments into ritual participants and issues a command that keeps the ceremony running.","reader_role":["Priest","Listener"],"function":"MAINTAIN","altars":["A_SILENCE","A_TIME"],"world_effect":"Creates continuity: the rite persists by command even when no literal sound can occur.","continuity_hook":"Directs the ‚Äòhow‚Äô of listening: away from senses, toward spirit."},
    {"line_id":"URN-L13","stanza":2,"text":"Not to the sensual ear, but, more endear'd,","rite_action":"Reassigns the congregation‚Äôs listening organ‚Äîtraining attention as a social practice.","reader_role":["Pilgrim","Listener"],"function":"TRANSFORM","altars":["A_SILENCE","A_COMMUNITY"],"world_effect":"Makes inwardness a shared norm; the community exists by agreeing where value resides.","continuity_hook":"Hands the ‚Äòtarget‚Äô of music to the next line: spirit-bound ditties."},
    {"line_id":"URN-L14","stanza":2,"text":"Pipe to the spirit ditties of no tone:","rite_action":"Defines an impossible music (no tone) as the ritual‚Äôs true hymn, binding the group through paradox.","reader_role":["Listener","Archivist"],"function":"PRODUCE","altars":["A_SILENCE","A_TRUTH"],"world_effect":"Produces a world where meaning can be sustained without material delivery‚Äîshared belief becomes infrastructure.","continuity_hook":"Shifts focus from music to figures on the urn: fair youth and trees."},
    {"line_id":"URN-L15","stanza":2,"text":"Fair youth, beneath the trees, thou canst not leave","rite_action":"Pins a character into timeless placement, turning limitation into a ceremonial guarantee.","reader_role":["Witness","Archivist"],"function":"MAINTAIN","altars":["A_TIME","A_DESIRE"],"world_effect":"Stabilizes the shared world by fixing roles and positions‚Äîcommunity through permanence.","continuity_hook":"Carries the constraint forward: song continues, trees remain."},
    {"line_id":"URN-L16","stanza":2,"text":"Thy song, nor ever can those trees be bare;","rite_action":"Chants ‚Äònor ever‚Äô as a durability clause, promising non-decay as communal comfort.","reader_role":["Citizen","Listener"],"function":"MAINTAIN","altars":["A_TIME","A_COMMUNITY"],"world_effect":"Maintains an order where loss is suspended; the reader joins a society that rehearses continuity.","continuity_hook":"Hands off to the love-scene: the bold lover‚Äôs kiss."},
    {"line_id":"URN-L17","stanza":2,"text":"Bold Lover, never, never canst thou kiss,","rite_action":"Performs the ritual wound: desire is held at the threshold, made permanent by refusal.","reader_role":["Lover","Witness"],"function":"REPAIR","altars":["A_DESIRE","A_TIME"],"world_effect":"Repairs the fear of endings by substituting suspended fulfillment for consummation-and-loss.","continuity_hook":"Adds consolation logic: near the goal, do not grieve."},
    {"line_id":"URN-L18","stanza":2,"text":"Though winning near the goal yet, do not grieve;","rite_action":"Issues pastoral counsel that re-frames deprivation as a stable communal condition.","reader_role":["Citizen","Judge"],"function":"REPAIR","altars":["A_DESIRE","A_COMMUNITY"],"world_effect":"Teaches the congregation a coping script: nearness can be enough when shared as doctrine.","continuity_hook":"Transfers consolation to the maiden: she cannot fade."},
    {"line_id":"URN-L19","stanza":2,"text":"She cannot fade, though thou hast not thy bliss,","rite_action":"Guarantees the beloved‚Äôs permanence as the ritual‚Äôs compensation for unfulfilled touch.","reader_role":["Lover","Witness"],"function":"MAINTAIN","altars":["A_TIME","A_DESIRE"],"world_effect":"Maintains the shared world by suspending decay, making beauty socially ‚Äòsafe‚Äô from time.","continuity_hook":"Opens the chant-keyword: ‚ÄòFor ever‚Äô as seal and refrain."},
    {"line_id":"URN-L20","stanza":2,"text":"For ever wilt thou love, and she be fair!","rite_action":"Activates the forever-procession as chant; love becomes a public liturgy rather than a private event.","reader_role":["Citizen","Listener"],"function":"MAINTAIN","altars":["A_TIME","A_TRUTH","A_DESIRE"],"world_effect":"Stabilizes society-in-time by repeating permanence as shared belief.","continuity_hook":"Hands into Chapel 3‚Äôs saturation chant (‚Äòhappy, happy‚Äô)."},

    {"line_id":"URN-L21","stanza":3,"text":"Ah, happy, happy boughs! that cannot shed","rite_action":"Begins a communal chant by repetition; ‚Äòhappy‚Äô works like a call-and-response to maintain mood.","reader_role":["Listener","Citizen"],"function":"MAINTAIN","altars":["A_TIME","A_COMMUNITY"],"world_effect":"Produces happiness as social atmosphere, not personal report‚Äîfelt true because shared aloud.","continuity_hook":"Carries the non-decay clause forward: leaves cannot fall."},
    {"line_id":"URN-L22","stanza":3,"text":"Your leaves, nor ever bid the Spring adieu;","rite_action":"Extends the ‚Äònor ever‚Äô spell to seasons, making renewal perpetual and communal.","reader_role":["Citizen"],"function":"MAINTAIN","altars":["A_TIME","A_TRUTH"],"world_effect":"Maintains an order where farewell is suspended; community repairs grief by denying departure.","continuity_hook":"Transfers the chant from trees to musician: ‚Äòhappy melodist.‚Äô"},
    {"line_id":"URN-L23","stanza":3,"text":"And, happy melodist, unwearied,","rite_action":"Blesses the performer with inexhaustion, turning labor into endless ritual service.","reader_role":["Listener","Archivist"],"function":"MAINTAIN","altars":["A_TIME","A_COMMUNITY"],"world_effect":"Stabilizes the world by promising that the ceremonial worker never tires‚Äîcontinuity guaranteed.","continuity_hook":"Keys the refrain: ‚ÄòFor ever piping‚Ä¶‚Äô"},
    {"line_id":"URN-L24","stanza":3,"text":"For ever piping songs for ever new;","rite_action":"Runs the forever-procession at full volume: repetition becomes the mechanism of maintenance.","reader_role":["Listener","Citizen"],"function":"MAINTAIN","altars":["A_TIME","A_SILENCE"],"world_effect":"Creates a paradoxical continuity: endless repetition that still feels new because it‚Äôs ritually renewed.","continuity_hook":"Moves the blessing to love itself‚Äîescalation chant."},
    {"line_id":"URN-L25","stanza":3,"text":"More happy love! more happy, happy love!","rite_action":"Intensifies the chant into a communal crescendo; emotion is socially manufactured by repetition.","reader_role":["Citizen","Lover"],"function":"PRODUCE","altars":["A_DESIRE","A_COMMUNITY"],"world_effect":"Produces a shared emotional order that feels authoritative because it is collectively repeated.","continuity_hook":"Hands to the next line‚Äôs permanence clauses (‚Äòfor ever warm‚Ä¶‚Äô)."},
    {"line_id":"URN-L26","stanza":3,"text":"For ever warm and still to be enjoy'd,","rite_action":"Defines desire as endlessly available and safe from cooling‚Äîritual comfort through stability.","reader_role":["Lover","Judge"],"function":"MAINTAIN","altars":["A_DESIRE","A_TIME"],"world_effect":"Maintains a world where pleasure is unthreatened by change, creating communal reassurance.","continuity_hook":"Turns warmth into motion: panting, youth."},
    {"line_id":"URN-L27","stanza":3,"text":"For ever panting, and for ever young;","rite_action":"Chants bodily intensity without consequence, making vitality a public, repeatable condition.","reader_role":["Lover","Citizen"],"function":"MAINTAIN","altars":["A_TIME","A_DESIRE"],"world_effect":"Sustains a shared fantasy of youth as social repair against aging and loss.","continuity_hook":"Sets up contrast: human passion vs. this elevated condition."},
    {"line_id":"URN-L28","stanza":3,"text":"All breathing human passion far above,","rite_action":"Draws a hierarchical boundary: the urn‚Äôs passion becomes a higher rite than ordinary human life.","reader_role":["Judge","Archivist"],"function":"TRANSFORM","altars":["A_TRUTH","A_TIME"],"world_effect":"Reframes reality: the community is invited to live by an elevated model sustained through ritual reading.","continuity_hook":"Forces the cost to appear: what human passion leaves behind."},
    {"line_id":"URN-L29","stanza":3,"text":"That leaves a heart high-sorrowful and cloy'd,","rite_action":"Introduces the break-point: acknowledges satiation and sorrow as the human remainder.","reader_role":["Witness","Judge"],"function":"REPAIR","altars":["A_DESIRE","A_COMMUNITY"],"world_effect":"Repairs the ritual‚Äôs credibility by naming the pain it is trying to relieve.","continuity_hook":"Translates inner cost into bodily symptoms (forehead, tongue)."},
    {"line_id":"URN-L30","stanza":3,"text":"A burning forehead, and a parching tongue.","rite_action":"Ends the chapel with embodied limit‚Äîmarks the human body as the site of excess and finitude.","reader_role":["Witness"],"function":"REPAIR","altars":["A_TIME","A_DESIRE"],"world_effect":"Repairs community by admitting appetite‚Äôs scorch; the ritual offers the urn‚Äôs stillness as countermedicine.","continuity_hook":"Opens Chapel 4: the civic ritual of sacrifice and town."},

    {"line_id":"URN-L31","stanza":4,"text":"Who are these coming to the sacrifice?","rite_action":"Reactivates the question-procession, shifting from erotic rite to civic rite‚Äîcommunity becomes visible as procession.","reader_role":["Citizen","Witness"],"function":"PRODUCE","altars":["A_COMMUNITY","A_TRUTH"],"world_effect":"Produces society as an enacted gathering rather than a set of facts.","continuity_hook":"Opens the altar-node explicitly: green altar and priest."},
    {"line_id":"URN-L32","stanza":4,"text":"To what green altar, O mysterious priest,","rite_action":"Uses apostrophe to appoint a ritual mediator (priest) and locate the ceremony at an altar-station.","reader_role":["Pilgrim","Citizen"],"function":"PRODUCE","altars":["A_COMMUNITY","A_DESIRE","A_TRUTH"],"world_effect":"Creates shared order by positing offices (priest) and stations (altar) as communal scaffolding.","continuity_hook":"Hands the action forward: leading the heifer."},
    {"line_id":"URN-L33","stanza":4,"text":"Lead'st thou that heifer lowing at the skies,","rite_action":"Animates sacrifice as ritual motion; sound (‚Äòlowing‚Äô) reaches skyward, linking earth to cosmos.","reader_role":["Witness","Archivist"],"function":"PRODUCE","altars":["A_COMMUNITY","A_TIME"],"world_effect":"Produces a world where communal action binds the vertical axis (earth/sky) without needing explanation.","continuity_hook":"Adds ornament and care: garlands, silken flanks."},
    {"line_id":"URN-L34","stanza":4,"text":"And all her silken flanks with garlands drest?","rite_action":"Marks the rite as aesthetic labor: decoration functions as public commitment and shared meaning.","reader_role":["Citizen","Judge"],"function":"MAINTAIN","altars":["A_COMMUNITY","A_TRUTH"],"world_effect":"Maintains social cohesion by showing how communities invest beauty into obligation.","continuity_hook":"Turns from procession to the absent town that produced it."},
    {"line_id":"URN-L35","stanza":4,"text":"What little town by river or sea shore,","rite_action":"Invokes civic geography; the map-function returns to make community imaginable as place.","reader_role":["Archivist","Citizen"],"function":"PRODUCE","altars":["A_COMMUNITY","A_TIME"],"world_effect":"Produces a shared civic world by naming possible habitats rather than confirming one.","continuity_hook":"Expands possible forms: mountain-built, citadel."},
    {"line_id":"URN-L36","stanza":4,"text":"Or mountain-built with peaceful citadel,","rite_action":"Stabilizes community by supplying a protective form (citadel) and a mood (peaceful).","reader_role":["Citizen","Judge"],"function":"MAINTAIN","altars":["A_COMMUNITY","A_TRUTH"],"world_effect":"Maintains the idea of ordered life‚Äîsociety as defended and named.","continuity_hook":"Sets up the rupture: the town is emptied."},
    {"line_id":"URN-L37","stanza":4,"text":"Is emptied of this folk, this pious morn?","rite_action":"Performs absence as communal fact: emptiness becomes the evidence of shared ritual obligation.","reader_role":["Witness","Citizen"],"function":"TRANSFORM","altars":["A_COMMUNITY","A_TIME","A_SILENCE"],"world_effect":"Transforms community into a negative space: society is maintained through what is missing.","continuity_hook":"Direct apostrophe to the town begins‚Äîtown as addressed participant."},
    {"line_id":"URN-L38","stanza":4,"text":"And, little town, thy streets for evermore","rite_action":"Apostrophizes the town and locks it into the forever-procession; civic time becomes a chant.","reader_role":["Citizen","Archivist"],"function":"MAINTAIN","altars":["A_TIME","A_COMMUNITY"],"world_effect":"Maintains the shared order by freezing civic life into an eternal ritual present.","continuity_hook":"Hands to the silence clause: streets will be silent."},
    {"line_id":"URN-L39","stanza":4,"text":"Will silent be; and not a soul to tell","rite_action":"Stages the ritual break: testimony disappears; community must persist without narrators.","reader_role":["Archivist","Witness"],"function":"REPAIR","altars":["A_SILENCE","A_COMMUNITY"],"world_effect":"Repairs meaning by making silence itself a binding medium when speech fails.","continuity_hook":"Completes the desolation logic: no one can return to explain why."},
    {"line_id":"URN-L40","stanza":4,"text":"Why thou art desolate, can e'er return.","rite_action":"Seals absence as irreversible; the ritual demands that the reader carry explanation as communal labor.","reader_role":["Archivist","Judge"],"function":"REPAIR","altars":["A_TIME","A_COMMUNITY","A_TRUTH"],"world_effect":"Repairs community by transferring ‚Äòtelling‚Äô to the congregation (readers) across time.","continuity_hook":"Opens Chapel 5: form praised, then the final seal is spoken."},

    {"line_id":"URN-L41","stanza":5,"text":"O Attic shape! Fair attitude! with brede","rite_action":"Begins the final chapel with praise-as-invocation; form itself becomes the ceremonial container of the world.","reader_role":["Pilgrim","Judge"],"function":"PRODUCE","altars":["A_TRUTH","A_COMMUNITY"],"world_effect":"Produces social authority through aesthetic address: the community agrees to treat shape as meaningful.","continuity_hook":"Hands to the contents of the form: marble people overwrought."},
    {"line_id":"URN-L42","stanza":5,"text":"Of marble men and maidens overwrought,","rite_action":"Populates the stage with communal figures; the urn becomes a civic archive of bodies and roles.","reader_role":["Archivist","Witness"],"function":"PRODUCE","altars":["A_COMMUNITY","A_TIME"],"world_effect":"Makes society durable: people persist as forms when living testimony fails.","continuity_hook":"Extends population into environment: branches and weed."},
    {"line_id":"URN-L43","stanza":5,"text":"With forest branches and the trodden weed;","rite_action":"Restores ordinary ground under the ceremonial scene; nature and wear become shared texture.","reader_role":["Witness"],"function":"MAINTAIN","altars":["A_TIME","A_COMMUNITY"],"world_effect":"Maintains realism through ritual texture‚Äîcommon ground legitimizes the staged world.","continuity_hook":"Returns to apostrophe: ‚ÄòThou, silent form‚Ä¶‚Äô"},
    {"line_id":"URN-L44","stanza":5,"text":"Thou, silent form, dost tease us out of thought","rite_action":"Declares the ritual technique: silence is not lack but a device that reshapes communal cognition.","reader_role":["Pilgrim","Archivist"],"function":"TRANSFORM","altars":["A_SILENCE","A_TRUTH"],"world_effect":"Transforms the congregation‚Äôs mode of knowing: wonder replaces explanation as social glue.","continuity_hook":"Links the teasing power to eternity‚Äîtime becomes the comparison."},
    {"line_id":"URN-L45","stanza":5,"text":"As doth eternity: Cold Pastoral!","rite_action":"Names the ambivalent affect (‚ÄòCold‚Äô) while still consecrating the pastoral as a lasting ritual form.","reader_role":["Judge","Witness"],"function":"REPAIR","altars":["A_TIME","A_DESIRE","A_TRUTH"],"world_effect":"Repairs the ceremony by admitting chill/alienation inside the shared order rather than denying it.","continuity_hook":"Shifts to generational time: old age wastes this generation."},
    {"line_id":"URN-L46","stanza":5,"text":"When old age shall this generation waste,","rite_action":"Marks the inevitable rupture (aging) that threatens community, establishing the need for the urn‚Äôs endurance.","reader_role":["Citizen","Witness"],"function":"PRODUCE","altars":["A_TIME","A_COMMUNITY"],"world_effect":"Produces historical time as shared threat, making the ritual‚Äôs promise socially necessary.","continuity_hook":"Sets up the counter-promise: ‚ÄòThou shalt remain‚Ä¶‚Äô"},
    {"line_id":"URN-L47","stanza":5,"text":"Thou shalt remain, in midst of other woe","rite_action":"Promises endurance amid changing sorrows; the urn becomes a persistent ceremonial anchor across eras.","reader_role":["Archivist","Citizen"],"function":"MAINTAIN","altars":["A_TIME","A_SILENCE"],"world_effect":"Maintains continuity of shared order by positing a stable form that outlives particular crises.","continuity_hook":"Introduces comparative suffering: woes beyond ours."},
    {"line_id":"URN-L48","stanza":5,"text":"Than ours, a friend to man, to whom thou say'st,","rite_action":"Assigns the urn a social role (friend) and a speech-act: it addresses humanity as an ongoing congregation.","reader_role":["Citizen","Judge"],"function":"PRODUCE","altars":["A_COMMUNITY","A_TRUTH"],"world_effect":"Produces a trans-generational community (‚Äòman‚Äô) maintained by recurrent address.","continuity_hook":"Opens the benediction quotation‚Äîfinal formula begins."},
    {"line_id":"URN-L49","stanza":5,"text":"Beauty is truth, truth beauty,‚Äîthat is all","rite_action":"Utters the ritual seal: a compact doctrine that stabilizes shared knowing by tying aesthetic form to truth.","reader_role":["Judge","Archivist"],"function":"MAINTAIN","altars":["A_TRUTH","A_COMMUNITY"],"world_effect":"Maintains communal order with an aphorism that can be repeated, taught, and inherited.","continuity_hook":"Completes the seal by limiting knowledge to what the rite authorizes."},
    {"line_id":"URN-L50","stanza":5,"text":"Ye know on earth, and all ye need to know.","rite_action":"Closes the ceremony by imposing epistemic limits; the community is repaired by a shared boundary on inquiry.","reader_role":["Citizen","Pilgrim"],"function":"REPAIR","altars":["A_TRUTH","A_TIME","A_COMMUNITY"],"world_effect":"Repairs anxiety by making ‚Äòenough‚Äô a communal agreement‚Äîreading becomes belonging.","continuity_hook":"Final closure: the ritual ends with a benediction that can be reenacted in future readings."}
  ]
};

/* ============================================================
   State
   ============================================================ */

const state = {
  view: "grid",
  q: "",
  altarOn: new Set(),
  procOn: new Set(),
  hideNonMatching: false,
  autoDetectProc: true,
  highlightTags: true,

  deck: {
    chapel: "ALL",
    order: [],
    idx: 0,
    face: "front"
  },

  mass: {
    order: [],
    idx: 0
  },

  modal: {
    currentId: null
  }
};

const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

function normalize(s){ return (s||"").toLowerCase(); }
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
function copyToClipboard(text){
  if (!navigator.clipboard) {
    // Fallback
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
    return Promise.resolve();
  }
  return navigator.clipboard.writeText(text);
}

/* ============================================================
   Procession detection (heuristics)
   ============================================================ */

function detectProcessions(line){
  const text = line.text || "";
  const t = normalize(text);

  const pros = new Set();

  // PR_Q: any question mark OR starts with what/who/to what etc.
  if (text.includes("?") || t.startsWith("what ") || t.startsWith("who ") || t.startsWith("to what ")) pros.add("PR_Q");

  // PR_APOS: apostrophe/direct address ("thou", "o ", "ye ", "fair youth", "bold lover", "and, little town")
  const aposSignals = [
    "thou", "o ", "ye ", "fair youth", "bold lover", "little town", "attic shape", "silent form", "mysterious priest"
  ];
  if (aposSignals.some(sig => t.includes(sig))) pros.add("PR_APOS");

  // PR_FOREVER: "for ever", "for evermore", "nor ever", repeated never
  if (t.includes("for ever") || t.includes("for evermore") || t.includes("nor ever") || t.includes("never, never")) pros.add("PR_FOREVER");

  return Array.from(pros);
}

/* ============================================================
   Filtering
   ============================================================ */

function lineMatches(line){
  const q = normalize(state.q).trim();
  const fields = [
    line.line_id,
    line.text,
    line.rite_action,
    line.world_effect,
    line.continuity_hook,
    (line.reader_role||[]).join(" "),
    (line.altars||[]).join(" ")
  ].map(normalize).join(" ‚Ä¢ ");

  const qOk = !q || fields.includes(q);

  const altarOk = state.altarOn.size === 0 || (line.altars||[]).some(a => state.altarOn.has(a));

  const procs = getLineProcessions(line);
  const procOk = state.procOn.size === 0 || procs.some(p => state.procOn.has(p));

  return qOk && altarOk && procOk;
}

function getLineProcessions(line){
  // Combine explicit if ever added + auto detection (default on)
  const auto = state.autoDetectProc ? detectProcessions(line) : [];
  const explicit = line.processions || [];
  const set = new Set([...explicit, ...auto]);
  return Array.from(set);
}

function filteredLines(){
  return DATA.rite_lines.filter(lineMatches);
}

/* ============================================================
   Rendering: Grid
   ============================================================ */

function altarName(id){
  return (DATA.altars.find(a=>a.id===id)||{}).name || id;
}

function chapelMeta(stanza){
  return DATA.chapels.find(c => c.stanza === stanza);
}

function makeBadge(text, cls){
  const span = document.createElement("span");
  span.className = "badge " + (cls||"");
  span.textContent = text;
  return span;
}

function renderGrid(){
  const root = $("#chapelGrid");
  root.innerHTML = "";

  // Create a map stanza -> lines in order
  const byStanza = new Map();
  for (let s=1;s<=5;s++){
    byStanza.set(s, DATA.rite_lines.filter(l=>l.stanza===s));
  }

  for (let s=1;s<=5;s++){
    const ch = chapelMeta(s);
    const col = document.createElement("section");
    col.className = "chapel";
    col.setAttribute("aria-label", `Chapel ${ch.id}`);

    const head = document.createElement("div");
    head.className = "ch-head";

    const title = document.createElement("div");
    title.className = "ch-title";
    title.innerHTML = `<strong>${ch.id} ‚Äî ${ch.name}</strong><span>${ch.lines}</span>`;

    const diag = document.createElement("div");
    diag.className = "ch-diagram";
    diag.innerHTML = `
      <div><b>ENTRY:</b> ${ch.diagram.ENTRY}</div>
      <div><b>CHANT:</b> ${ch.diagram.CHANT}</div>
      <div><b>TURN:</b> ${ch.diagram.TURN}</div>
      <div><b>SEAL:</b> ${ch.diagram.SEAL}</div>
    `;

    head.appendChild(title);
    head.appendChild(diag);
    col.appendChild(head);

    const grid = document.createElement("div");
    grid.className = "lines";

    const lines = byStanza.get(s);
    lines.forEach((line) => {
      const match = lineMatches(line);

      const cell = document.createElement("div");
      cell.className = "cell";
      cell.dataset.id = line.line_id;

      if (state.hideNonMatching && !match) cell.dataset.hide = "true";
      if (!state.hideNonMatching && !match && (state.altarOn.size || state.procOn.size || state.q)) cell.dataset.dim = "true";

      cell.addEventListener("click", () => openModal(line.line_id));

      const lid = document.createElement("div");
      lid.className = "lid";
      lid.innerHTML = `
        <div>${line.line_id}</div>
        <div class="fn" data-fn="${line.function}">${line.function}</div>
      `;

      const ctext = document.createElement("div");
      ctext.className = "ctext";
      const p = document.createElement("p");
      p.className = "line";
      p.textContent = line.text;

      const badges = document.createElement("div");
      badges.className = "badges";

      if (state.highlightTags) {
        // Altars
        (line.altars||[]).slice(0,3).forEach(a=>{
          const b = makeBadge(a.replace("A_",""), "altar");
          b.title = altarName(a);
          b.addEventListener("click", (e)=>{ e.stopPropagation(); toggleAltar(a); });
          badges.appendChild(b);
        });

        // Processions
        const procs = getLineProcessions(line);
        procs.slice(0,2).forEach(pn=>{
          const b = makeBadge(pn.replace("PR_",""), "proc");
          b.title = pn;
          b.addEventListener("click", (e)=>{ e.stopPropagation(); toggleProc(pn); });
          badges.appendChild(b);
        });
      }

      ctext.appendChild(p);
      ctext.appendChild(badges);

      cell.appendChild(lid);
      cell.appendChild(ctext);

      grid.appendChild(cell);
    });

    col.appendChild(grid);
    root.appendChild(col);
  }
}

/* ============================================================
   Rendering: Cards
   ============================================================ */

function buildDeckOrder(){
  // Base: filtered lines (respect global filters)
  const lines = filteredLines();

  let pool = lines;
  if (state.deck.chapel !== "ALL"){
    const s = Number(state.deck.chapel);
    pool = lines.filter(l=>l.stanza===s);
  }

  // If user hasn't shuffled/reset yet, keep canonical order
  // But we track order as IDs.
  state.deck.order = pool.map(l=>l.line_id);
  state.deck.idx = 0;
  state.deck.face = "front";
}

function shuffleDeck(){
  const arr = state.deck.order.slice();
  // Fisher‚ÄìYates
  for (let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  state.deck.order = arr;
  state.deck.idx = 0;
}

function currentDeckLine(){
  const id = state.deck.order[state.deck.idx];
  return DATA.rite_lines.find(l=>l.line_id===id) || null;
}

function renderSeals(){
  const seals = [
    {id:"C1 SEAL", line:"URN-L10"},
    {id:"C2 SEAL", line:"URN-L20"},
    {id:"C3 SEAL", line:"URN-L30"},
    {id:"C4 SEAL", line:"URN-L40"},
    {id:"C5 SEAL", line:"URN-L50"}
  ];
  const root = $("#sealList");
  root.innerHTML = "";
  seals.forEach(s=>{
    const line = DATA.rite_lines.find(l=>l.line_id===s.line);
    if (!line) return;
    const div = document.createElement("div");
    div.className = "sline";
    div.innerHTML = `<div class="tag">${s.id}</div><p>${line.text}</p>`;
    div.addEventListener("click", ()=>openModal(line.line_id));
    root.appendChild(div);
  });
}

function renderCard(){
  // Ensure order exists
  if (!state.deck.order.length) buildDeckOrder();

  // Clamp
  state.deck.idx = clamp(state.deck.idx, 0, Math.max(0, state.deck.order.length-1));

  const line = currentDeckLine();
  const total = state.deck.order.length || 0;

  $("#deckCount").textContent = total ? `${state.deck.idx + 1} / ${total}` : `0 / 0`;

  const card = $("#card");
  card.dataset.face = state.deck.face;

  if (!line){
    $("#cardId").textContent = "‚Äî";
    $("#cardText").textContent = "No lines in deck (filters removed everything).";
    $("#cardBadges").innerHTML = "";
    $("#cardAction").textContent = "";
    $("#cardEffect").textContent = "";
    $("#cardHook").textContent = "";
    $("#cardBadgesB").innerHTML = "";
    return;
  }

  // FRONT
  $("#cardId").textContent = line.line_id;
  $("#cardIdB").textContent = line.line_id;

  $("#cardFn").textContent = line.function;
  $("#cardFnB").textContent = line.function;
  $("#cardFn").dataset.fn = line.function;
  $("#cardFnB").dataset.fn = line.function;

  $("#cardText").textContent = line.text;

  const badgesA = $("#cardBadges");
  badgesA.innerHTML = "";
  (line.altars||[]).forEach(a=>{
    const b = makeBadge(a.replace("A_",""), "altar");
    b.title = altarName(a);
    b.addEventListener("click", (e)=>{ e.stopPropagation(); toggleAltar(a); });
    badgesA.appendChild(b);
  });
  getLineProcessions(line).forEach(p=>{
    const b = makeBadge(p.replace("PR_",""), "proc");
    b.title = p;
    b.addEventListener("click", (e)=>{ e.stopPropagation(); toggleProc(p); });
    badgesA.appendChild(b);
  });

  // BACK
  $("#cardAction").textContent = line.rite_action;
  $("#cardEffect").textContent = line.world_effect;
  $("#cardHook").textContent = line.continuity_hook;

  const badgesB = $("#cardBadgesB");
  badgesB.innerHTML = "";
  const roles = (line.reader_role || []);
  roles.forEach(r=>{
    badgesB.appendChild(makeBadge(r, ""));
  });
  (line.altars||[]).forEach(a=>{
    const b = makeBadge(a, "altar");
    b.title = altarName(a);
    b.addEventListener("click", (e)=>{ e.stopPropagation(); toggleAltar(a); });
    badgesB.appendChild(b);
  });
}

/* ============================================================
   Rendering: Mass
   ============================================================ */

function massCategory(line){
  // BENEDICTION explicitly last two lines
  if (line.line_id === "URN-L49" || line.line_id === "URN-L50") return "BENEDICTION";

  const procs = getLineProcessions(line);
  const t = normalize(line.text);

  if (procs.includes("PR_APOS")) return "CALL";
  if (procs.includes("PR_Q")) return "RESPONSE";
  if (procs.includes("PR_FOREVER") || t.includes("happy") || t.includes("never, never") || t.includes("nor ever")) return "CHANT";

  return "TEXT";
}

function buildMassOrder(){
  const lines = filteredLines();
  // Prefer canonical time order for mass traversal, but keep only CALL/RESPONSE/CHANT/BENED for the player
  const important = lines.filter(l => ["CALL","RESPONSE","CHANT","BENEDICTION"].includes(massCategory(l)));
  state.mass.order = important.map(l=>l.line_id);
  state.mass.idx = 0;
}

function renderMassLists(){
  const lines = filteredLines();

  const groups = {
    CALL: [],
    RESPONSE: [],
    CHANT: [],
    BENEDICTION: []
  };

  lines.forEach(l=>{
    const cat = massCategory(l);
    if (groups[cat]) groups[cat].push(l);
  });

  // Render each list
  const renderList = (rootId, arr) => {
    const root = $(rootId);
    root.innerHTML = "";
    arr.forEach(l=>{
      const div = document.createElement("div");
      div.className = "sline";
      div.dataset.id = l.line_id;
      div.innerHTML = `<div class="tag">${l.line_id}</div><p>${l.text}</p>`;
      div.addEventListener("click", () => {
        const idx = state.mass.order.indexOf(l.line_id);
        if (idx >= 0) {
          state.mass.idx = idx;
          renderMassPlayer();
        }
        openModal(l.line_id);
      });
      root.appendChild(div);
    });
  };

  renderList("#listCall", groups.CALL);
  renderList("#listResp", groups.RESPONSE);
  renderList("#listChant", groups.CHANT);
  renderList("#listBened", groups.BENEDICTION);

  $("#countCall").textContent = groups.CALL.length;
  $("#countResp").textContent = groups.RESPONSE.length;
  $("#countChant").textContent = groups.CHANT.length;
  $("#countBened").textContent = groups.BENEDICTION.length;
}

function currentMassLine(){
  const id = state.mass.order[state.mass.idx];
  return DATA.rite_lines.find(l=>l.line_id===id) || null;
}

function renderMassPlayer(){
  if (!state.mass.order.length) buildMassOrder();
  state.mass.idx = clamp(state.mass.idx, 0, Math.max(0, state.mass.order.length-1));

  const line = currentMassLine();
  const total = state.mass.order.length;

  $("#nowIdx").textContent = total ? `${state.mass.idx + 1} / ${total}` : `0 / 0`;

  if (!line){
    $("#nowRole").textContent = "‚Äî";
    $("#nowId").textContent = "";
    $("#nowText").textContent = "No lines in script (filters removed everything).";
    $("#nowNote").textContent = "";
    return;
  }

  const cat = massCategory(line);
  $("#nowRole").textContent = cat;
  $("#nowId").textContent = line.line_id;
  $("#nowText").textContent = line.text;
  $("#nowNote").textContent = line.rite_action;
}

/* ============================================================
   Modal
   ============================================================ */

function openModal(lineId){
  const line = DATA.rite_lines.find(l=>l.line_id===lineId);
  if (!line) return;

  state.modal.currentId = lineId;

  $("#dlgId").textContent = line.line_id;
  $("#dlgTitle").textContent = `Stanza ${line.stanza} ‚Äî ${line.function}`;
  $("#dlgText").textContent = line.text;

  const meta = $("#dlgMeta");
  meta.innerHTML = "";
  meta.appendChild(makeBadge(line.function, "mini"));
  (line.reader_role||[]).forEach(r => meta.appendChild(makeBadge(r, "mini")));

  $("#dlgAction").textContent = line.rite_action;
  $("#dlgEffect").textContent = line.world_effect;
  $("#dlgHook").textContent = line.continuity_hook;

  const tags = $("#dlgTags");
  tags.innerHTML = "";
  (line.altars||[]).forEach(a=>{
    const b = makeBadge(a, "altar");
    b.title = altarName(a);
    b.addEventListener("click", ()=>{ toggleAltar(a); });
    tags.appendChild(b);
  });
  getLineProcessions(line).forEach(p=>{
    const b = makeBadge(p, "proc");
    b.addEventListener("click", ()=>{ toggleProc(p); });
    tags.appendChild(b);
  });

  $("#dlg").showModal();
}

function closeModal(){
  $("#dlg").close();
}

function modalNav(dir){
  const ids = DATA.rite_lines.map(l=>l.line_id);
  const curIdx = ids.indexOf(state.modal.currentId);
  if (curIdx < 0) return;
  const newIdx = clamp(curIdx + dir, 0, ids.length - 1);
  openModal(ids[newIdx]);
}

/* ============================================================
   Chip / filter toggles
   ============================================================ */

function toggleAltar(id){
  if (state.altarOn.has(id)) state.altarOn.delete(id);
  else state.altarOn.add(id);
  syncChips();
  rerender();
}

function toggleProc(id){
  if (state.procOn.has(id)) state.procOn.delete(id);
  else state.procOn.add(id);
  syncChips();
  rerender();
}

function syncChips(){
  $$("[data-altar]").forEach(el=>{
    const on = state.altarOn.has(el.dataset.altar);
    el.dataset.on = on;
    el.setAttribute("aria-pressed", on);
  });
  $$("[data-proc]").forEach(el=>{
    const on = state.procOn.has(el.dataset.proc);
    el.dataset.on = on;
    el.setAttribute("aria-pressed", on);
  });
  $("#chipHide").dataset.on = state.hideNonMatching;
  $("#chipHide").setAttribute("aria-pressed", state.hideNonMatching);
  $("#chipAuto").dataset.on = state.autoDetectProc;
  $("#chipAuto").setAttribute("aria-pressed", state.autoDetectProc);
}

/* ============================================================
   View switching
   ============================================================ */

function setView(v){
  state.view = v;
  $("#viewGrid").classList.toggle("hide", v!=="grid");
  $("#viewCards").classList.toggle("hide", v!=="cards");
  $("#viewMass").classList.toggle("hide", v!=="mass");

  // Tabs
  ["tabGrid","tabCards","tabMass"].forEach(id=>{
    const el = $("#"+id);
    const match = id.toLowerCase().includes(v);
    el.setAttribute("aria-selected", match);
    el.setAttribute("aria-pressed", match);
  });

  // Bottom nav
  ["bGrid","bCards","bMass"].forEach(id=>{
    const el = $("#"+id);
    const match = id.toLowerCase().replace("b","").includes(v);
    el.dataset.on = match;
  });

  rerender();
}

/* ============================================================
   Rerender
   ============================================================ */

function rerender(){
  if (state.view === "grid") renderGrid();
  if (state.view === "cards"){
    buildDeckOrder();
    renderCard();
    renderSeals();
  }
  if (state.view === "mass"){
    buildMassOrder();
    renderMassLists();
    renderMassPlayer();
  }
}

/* ============================================================
   Reset
   ============================================================ */

function resetAll(){
  state.q = "";
  state.altarOn.clear();
  state.procOn.clear();
  state.hideNonMatching = false;
  state.autoDetectProc = true;
  state.highlightTags = true;
  $("#q").value = "";
  syncChips();
  rerender();
}

/* ============================================================
   Event bindings
   ============================================================ */

function init(){
  // View tabs
  $("#tabGrid").addEventListener("click", ()=>setView("grid"));
  $("#tabCards").addEventListener("click", ()=>setView("cards"));
  $("#tabMass").addEventListener("click", ()=>setView("mass"));

  // Bottom nav
  $("#bGrid").addEventListener("click", ()=>setView("grid"));
  $("#bCards").addEventListener("click", ()=>setView("cards"));
  $("#bMass").addEventListener("click", ()=>setView("mass"));
  $("#bFilters").addEventListener("click", ()=>{
    // Toggle filter tray visibility on mobile (simple toggle)
    const tray = $("header .tray");
    tray.classList.toggle("hide");
    $("#bFilters").dataset.on = !tray.classList.contains("hide");
  });

  // Search
  $("#q").addEventListener("input", (e)=>{
    state.q = e.target.value;
    rerender();
  });

  // Chips
  $$("[data-altar]").forEach(el=>{
    el.addEventListener("click", ()=>toggleAltar(el.dataset.altar));
    el.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" ") toggleAltar(el.dataset.altar); });
  });
  $$("[data-proc]").forEach(el=>{
    el.addEventListener("click", ()=>toggleProc(el.dataset.proc));
    el.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" ") toggleProc(el.dataset.proc); });
  });
  $("#chipHide").addEventListener("click", ()=>{
    state.hideNonMatching = !state.hideNonMatching;
    syncChips();
    rerender();
  });
  $("#chipAuto").addEventListener("click", ()=>{
    state.autoDetectProc = !state.autoDetectProc;
    syncChips();
    rerender();
  });

  // Grid actions
  $("#btnFocusAltars").addEventListener("click", ()=>{
    state.highlightTags = !state.highlightTags;
    rerender();
  });
  $("#btnOpenRepair").addEventListener("click", ()=>{
    alert("Repair logic:\n\n‚Ä¢ Suspended desire (L17‚ÄìL20): deprivation reframed as permanence.\n‚Ä¢ Human saturation (L29‚ÄìL30): bodily limits restore credibility.\n‚Ä¢ Testimony collapse (L39‚ÄìL40): readers inherit duty to tell.\n‚Ä¢ Ambivalence (L45): chill admitted, then sealed with aphorism (L49‚ÄìL50).");
  });

  // Reset & Export
  $("#btnReset").addEventListener("click", resetAll);
  $("#btnExport").addEventListener("click", ()=>{
    const out = {
      prompt_id: DATA.prompt_id,
      filtered_lines: filteredLines()
    };
    copyToClipboard(JSON.stringify(out, null, 2)).then(()=>alert("Copied JSON to clipboard."));
  });

  // Cards
  $("#card").addEventListener("click", ()=>{
    state.deck.face = state.deck.face === "front" ? "back" : "front";
    renderCard();
  });
  $("#btnFlip").addEventListener("click", ()=>{
    state.deck.face = state.deck.face === "front" ? "back" : "front";
    renderCard();
  });
  $("#btnPrev").addEventListener("click", ()=>{
    state.deck.idx = Math.max(0, state.deck.idx - 1);
    state.deck.face = "front";
    renderCard();
  });
  $("#btnNext").addEventListener("click", ()=>{
    state.deck.idx = Math.min(state.deck.order.length - 1, state.deck.idx + 1);
    state.deck.face = "front";
    renderCard();
  });
  $("#deckChapel").addEventListener("change", (e)=>{
    state.deck.chapel = e.target.value;
    buildDeckOrder();
    renderCard();
  });
  $("#btnShuffle").addEventListener("click", ()=>{
    shuffleDeck();
    renderCard();
  });
  $("#btnResetDeck").addEventListener("click", ()=>{
    buildDeckOrder();
    renderCard();
  });
  $("#btnOpenCurrent").addEventListener("click", ()=>{
    const line = currentDeckLine();
    if (line) openModal(line.line_id);
  });
  $("#btnCopyCurrent").addEventListener("click", ()=>{
    const line = currentDeckLine();
    if (line) copyToClipboard(JSON.stringify(line, null, 2)).then(()=>alert("Copied line JSON."));
  });

  // Mass
  $("#btnStartMass").addEventListener("click", ()=>{
    buildMassOrder();
    state.mass.idx = 0;
    renderMassPlayer();
  });
  $("#btnStepPrev").addEventListener("click", ()=>{
    state.mass.idx = Math.max(0, state.mass.idx - 1);
    renderMassPlayer();
  });
  $("#btnStepNext").addEventListener("click", ()=>{
    state.mass.idx = Math.min(state.mass.order.length - 1, state.mass.idx + 1);
    renderMassPlayer();
  });
  $("#btnExpandAll").addEventListener("click", ()=>{
    ["secCall","secResp","secChant","secBened"].forEach(id=>$("#"+id).open = true);
  });
  $("#btnCollapseAll").addEventListener("click", ()=>{
    ["secCall","secResp","secChant","secBened"].forEach(id=>$("#"+id).open = false);
  });
  $("#btnJumpOpen").addEventListener("click", ()=>{
    const line = currentMassLine();
    if (line) openModal(line.line_id);
  });
  $("#btnJumpCopy").addEventListener("click", ()=>{
    const line = currentMassLine();
    if (line) copyToClipboard(JSON.stringify(line, null, 2)).then(()=>alert("Copied line JSON."));
  });
  $("#btnJumpGrid").addEventListener("click", ()=>{
    setView("grid");
    // Optionally scroll to the line
  });

  // Modal
  $("#dlgClose").addEventListener("click", closeModal);
  $("#dlgPrev").addEventListener("click", ()=>modalNav(-1));
  $("#dlgNext").addEventListener("click", ()=>modalNav(1));
  $("#dlgCopy").addEventListener("click", ()=>{
    const line = DATA.rite_lines.find(l=>l.line_id===state.modal.currentId);
    if (line) copyToClipboard(JSON.stringify(line, null, 2)).then(()=>alert("Copied."));
  });
  $("#dlg").addEventListener("click", (e)=>{
    if (e.target === $("#dlg")) closeModal();
  });

  // Initial render
  syncChips();
  renderSeals();
  rerender();
}

document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
