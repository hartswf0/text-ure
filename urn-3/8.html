<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ritual Cartography: Ode on a Grecian Urn</title>
    <style>
        :root {
            /* Ritual Palette */
            --bg-marble: #f4f1ea;
            --bg-marble-dark: #e8e4dc;
            --text-ink: #2c3e50;
            --text-faded: #7f8c8d;
            --accent-gold: #b7950b;
            --border-color: #dcd6cc;
            
            /* Altar Colors */
            --c-silence: #7f8c8d;
            --c-time: #8e44ad;
            --c-desire: #c0392b;
            --c-community: #d35400;
            --c-truth: #2980b9;
            
            /* Typography */
            --font-body: 'Georgia', serif;
            --font-sans: 'Helvetica Neue', sans-serif;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-marble);
            color: var(--text-ink);
            font-family: var(--font-body);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            background: #fff;
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 10;
        }

        h1 {
            font-size: 1.2rem;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-ink);
        }

        .subtitle {
            font-size: 0.8rem;
            font-family: var(--font-sans);
            color: var(--text-faded);
        }

        .controls {
            display: flex;
            gap: 1rem;
        }

        button.btn-primary {
            background: var(--text-ink);
            color: #fff;
            border: none;
            padding: 0.5rem 1rem;
            font-family: var(--font-sans);
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
        }

        button.btn-primary:hover {
            background: var(--accent-gold);
        }

        /* --- Main Layout --- */
        main {
            flex: 1;
            display: grid;
            grid-template-columns: 3fr 1fr; /* Map vs Detail Panel */
            overflow: hidden;
        }

        /* --- The Map (Grid View) --- */
        #map-container {
            padding: 2rem;
            overflow-y: auto;
            overflow-x: auto;
            background: radial-gradient(circle at center, #fff, var(--bg-marble));
        }

        .chapel-grid {
            display: grid;
            grid-template-columns: repeat(5, minmax(220px, 1fr));
            gap: 1.5rem;
            max-width: 1600px;
            margin: 0 auto;
        }

        .chapel-column {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .chapel-header {
            text-align: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--accent-gold);
        }

        .chapel-title {
            font-family: var(--font-sans);
            font-weight: bold;
            font-size: 0.9rem;
            text-transform: uppercase;
            color: var(--accent-gold);
            letter-spacing: 1px;
        }

        .chapel-desc {
            font-size: 0.75rem;
            font-style: italic;
            color: var(--text-faded);
            margin-top: 0.2rem;
        }

        /* --- The Rite Line (Card) --- */
        .rite-card {
            background: #fff;
            border: 1px solid var(--border-color);
            padding: 0.8rem;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .rite-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: var(--text-ink);
        }

        .rite-card.active {
            border-color: var(--accent-gold);
            background-color: #fffae6;
            box-shadow: 0 0 0 2px var(--accent-gold);
        }

        .rite-card.dimmed {
            opacity: 0.3;
        }

        .line-text {
            font-size: 0.95rem;
            line-height: 1.4;
            margin-bottom: 0.5rem;
        }

        .line-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: var(--font-sans);
            font-size: 0.65rem;
            color: var(--text-faded);
            text-transform: uppercase;
        }

        .role-badge {
            background: var(--bg-marble-dark);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }

        /* --- Detail Panel (The Lectern) --- */
        #lectern {
            background: #fff;
            border-left: 1px solid var(--border-color);
            padding: 2rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .lectern-header {
            font-family: var(--font-sans);
            text-transform: uppercase;
            color: var(--text-faded);
            font-size: 0.8rem;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .lectern-content h2 {
            font-size: 1.4rem;
            margin: 0 0 1rem 0;
            line-height: 1.4;
        }

        .ritual-block {
            background: var(--bg-marble);
            padding: 1rem;
            border-radius: 4px;
            border-left: 4px solid var(--accent-gold);
        }

        .ritual-label {
            font-family: var(--font-sans);
            font-weight: bold;
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--text-faded);
            margin-bottom: 0.3rem;
            display: block;
        }

        .ritual-value {
            font-size: 1rem;
            margin-bottom: 1rem;
            display: block;
        }
        
        .ritual-value:last-child { margin-bottom: 0; }

        .altar-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .altar-tag {
            padding: 4px 8px;
            border-radius: 12px;
            font-family: var(--font-sans);
            font-size: 0.7rem;
            color: #fff;
            font-weight: bold;
        }

        /* --- Footer (Altar Controls) --- */
        footer {
            background: #fff;
            padding: 1rem 2rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 1rem;
            overflow-x: auto;
        }

        .filter-label {
            font-family: var(--font-sans);
            font-weight: bold;
            font-size: 0.8rem;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .altar-btn {
            background: none;
            border: 2px solid transparent;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            cursor: pointer;
            font-family: var(--font-sans);
            font-size: 0.8rem;
            font-weight: bold;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .altar-btn:hover {
            transform: scale(1.05);
        }

        .altar-btn.active {
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* Altar Specifics */
        .a-silence { background-color: var(--c-silence); color: white; }
        .a-time { background-color: var(--c-time); color: white; }
        .a-desire { background-color: var(--c-desire); color: white; }
        .a-community { background-color: var(--c-community); color: white; }
        .a-truth { background-color: var(--c-truth); color: white; }

        .line-marker {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 4px;
        }

        /* Responsive */
        @media (max-width: 900px) {
            main { grid-template-columns: 1fr; }
            #lectern { 
                position: fixed; 
                bottom: 0; 
                left: 0; 
                right: 0; 
                height: 40vh; 
                box-shadow: 0 -4px 20px rgba(0,0,0,0.1); 
                z-index: 100;
                transform: translateY(100%);
                transition: transform 0.3s;
            }
            #lectern.open { transform: translateY(0); }
            .chapel-grid { display: flex; flex-direction: column; }
        }
    </style>
</head>
<body>

<header>
    <div>
        <h1>Ritual Cartography</h1>
        <div class="subtitle">James W. Carey's View Applied to Keats' Urn</div>
    </div>
    <div class="controls">
        <button class="btn-primary" onclick="toggleProcession()" id="procBtn">Start Procession</button>
    </div>
</header>

<main>
    <div id="map-container">
        <div class="chapel-grid" id="grid">
            <!-- Columns injected by JS -->
        </div>
    </div>

    <aside id="lectern" class="open">
        <div class="lectern-header">The Rite Unit</div>
        <div id="lectern-content" class="lectern-content">
            <div style="color: var(--text-faded); text-align: center; margin-top: 3rem;">
                Select a line from the map to view its ritual function.
            </div>
        </div>
    </aside>
</main>

<footer>
    <div class="filter-label">Trace Altar Lines:</div>
    <button class="altar-btn a-silence" onclick="filterMap('A_SILENCE')">Silence</button>
    <button class="altar-btn a-time" onclick="filterMap('A_TIME')">Time</button>
    <button class="altar-btn a-desire" onclick="filterMap('A_DESIRE')">Desire</button>
    <button class="altar-btn a-community" onclick="filterMap('A_COMMUNITY')">Community</button>
    <button class="altar-btn a-truth" onclick="filterMap('A_TRUTH')">Truth</button>
    <button class="altar-btn" style="border: 1px solid #ccc; color: #666;" onclick="resetFilter()">Reset</button>
</footer>

<script>
    // --- Data: The Ritual Map ---
    const chapels = [
        { id: "C1", name: "I. Invocation", desc: "Establishing the Sacred Object" },
        { id: "C2", name: "II. Suspension", desc: "The Unheard & Unkissed" },
        { id: "C3", name: "III. Saturation", desc: "The Evergreen Chant" },
        { id: "C4", name: "IV. Sacrifice", desc: "The Civic Procession" },
        { id: "C5", name: "V. Covenant", desc: "The Formulaic Seal" }
    ];

    const altars = {
        "A_SILENCE": { name: "Silence", color: "var(--c-silence)" },
        "A_TIME": { name: "Time", color: "var(--c-time)" },
        "A_DESIRE": { name: "Desire", color: "var(--c-desire)" },
        "A_COMMUNITY": { name: "Community", color: "var(--c-community)" },
        "A_TRUTH": { name: "Truth", color: "var(--c-truth)" }
    };

    const lines = [
        // C1
        { id: "L01", c: "C1", text: "Thou still unravish'd bride of quietness,", action: "Consecrates the object as a ceremonial partner.", role: "Pilgrim", func: "PRODUCE", altars: ["A_SILENCE", "A_DESIRE"], effect: "Establishes a reality where an object has agency." },
        { id: "L02", c: "C1", text: "Thou foster-child of silence and slow time,", action: "Installs 'slow time' as the liturgical tempo.", role: "Witness", func: "MAINTAIN", altars: ["A_TIME", "A_SILENCE"], effect: "Stabilizes an order where things age but do not decay." },
        { id: "L03", c: "C1", text: "Sylvan historian, who canst thus express", action: "Invests the object with the office of 'Historian.'", role: "Archivist", func: "PRODUCE", altars: ["A_TRUTH"], effect: "Constructs a world where art records history better than text." },
        { id: "L04", c: "C1", text: "A flowery tale more sweetly than our rhyme:", action: "Humbles the poet. Submits language to image.", role: "Judge", func: "TRANSFORM", altars: ["A_TRUTH"], effect: "Transfers trust from speech to silent form." },
        { id: "L05", c: "C1", text: "What leaf-fring'd legend haunts about thy shape", action: "Summons the legend as a ghost ('haunts').", role: "Seeker", func: "PRODUCE", altars: ["A_COMMUNITY"], effect: "Creates a mystery demanding group attention." },
        { id: "L06", c: "C1", text: "Of deities or mortals, or of both,", action: "Classifies participants. Ritual taxonomy.", role: "Classifier", func: "MAINTAIN", altars: ["A_COMMUNITY"], effect: "Maintains boundary of sacred and profane." },
        { id: "L07", c: "C1", text: "In Tempe or the dales of Arcady?", action: "Places congregation in mythic geography.", role: "Pilgrim", func: "PRODUCE", altars: ["A_TIME"], effect: "Produces 'There' as a shared coordinate." },
        { id: "L08", c: "C1", text: "What men or gods are these? What maidens loth?", action: "Accelerates Question-Procession. Shared energy.", role: "Witness", func: "REPAIR", altars: ["A_DESIRE"], effect: "Repairs anxiety of not-knowing by ritualizing it." },
        { id: "L09", c: "C1", text: "What mad pursuit? What struggle to escape?", action: "Stages predator/prey drama.", role: "Observer", func: "PRODUCE", altars: ["A_DESIRE"], effect: "Produces conflict as engine of the world." },
        { id: "L10", c: "C1", text: "What pipes and timbrels? What wild ecstasy?", action: "Invokes sound that cannot be heard.", role: "Listener", func: "MAINTAIN", altars: ["A_SILENCE"], effect: "Maintains paradox: noise preserved in silence." },
        
        // C2
        { id: "L11", c: "C2", text: "Heard melodies are sweet, but those unheard", action: "Inverts hierarchy of senses. Inner Ear dogma.", role: "Initiate", func: "TRANSFORM", altars: ["A_SILENCE"], effect: "Transforms absence into spiritual presence." },
        { id: "L12", c: "C2", text: "Are sweeter; therefore, ye soft pipes, play on;", action: "Commands the inanimate. Reader conducts.", role: "Conductor", func: "MAINTAIN", altars: ["A_SILENCE"], effect: "Sustains impossible performance via belief." },
        { id: "L13", c: "C2", text: "Not to the sensual ear, but, more endear'd,", action: "Refines ritual instruction. Rejects body.", role: "Mystic", func: "REPAIR", altars: ["A_TRUTH"], effect: "Repairs limitations of human hearing." },
        { id: "L14", c: "C2", text: "Pipe to the spirit ditties of no tone:", action: "Establishes telepathic communion.", role: "Mystic", func: "PRODUCE", altars: ["A_SILENCE", "A_COMMUNITY"], effect: "Produces 'spirit realm' accessible only via poem." },
        { id: "L15", c: "C2", text: "Fair youth, beneath the trees, thou canst not leave", action: "Binds actor to scenery. Ritual confinement.", role: "Warden", func: "MAINTAIN", altars: ["A_TIME"], effect: "Maintains world without departure." },
        { id: "L16", c: "C2", text: "Thy song, nor ever can those trees be bare;", action: "Banishes winter. Fertility rite frozen.", role: "Gardener", func: "MAINTAIN", altars: ["A_TIME"], effect: "Ensures perpetual harvest." },
        { id: "L17", c: "C2", text: "Bold Lover, never, never canst thou kiss,", action: "Pronounces Holy Curse. Denies act to save feeling.", role: "Judge", func: "TRANSFORM", altars: ["A_DESIRE", "A_TIME"], effect: "Transforms frustration into monument." },
        { id: "L18", c: "C2", text: "Though winning near the goal yet, do not grieve;", action: "Offers pastoral counseling.", role: "Comforter", func: "REPAIR", altars: ["A_DESIRE"], effect: "Repairs pain of unfulfillment." },
        { id: "L19", c: "C2", text: "She cannot fade, though thou hast not thy bliss,", action: "Codifies trade-off: Loss of pleasure = Gain of permanence.", role: "Economist", func: "MAINTAIN", altars: ["A_TRUTH"], effect: "Maintains value where nothing depreciates." },
        { id: "L20", c: "C2", text: "For ever wilt thou love, and she be fair!", action: "Seals C2 with Forever-Procession.", role: "Believer", func: "MAINTAIN", altars: ["A_TIME", "A_DESIRE"], effect: "Locks community into static love." },

        // C3
        { id: "L21", c: "C3", text: "Ah, happy, happy boughs! that cannot shed", action: "Begins the 'Happy' Chant. Ritual trance.", role: "Worshipper", func: "MAINTAIN", altars: ["A_TIME"], effect: "Reinforces reality of evergreen world." },
        { id: "L22", c: "C3", text: "Your leaves, nor ever bid the Spring adieu;", action: "Exorcises farewells. Binds timeline.", role: "Worshipper", func: "MAINTAIN", altars: ["A_TIME"], effect: "Creates seasonless reality." },
        { id: "L23", c: "C3", text: "And, happy melodist, unwearied,", action: "Celebrates removal of fatigue.", role: "Worshipper", func: "PRODUCE", altars: ["A_SILENCE"], effect: "Produces image of effort without exhaustion." },
        { id: "L24", c: "C3", text: "For ever piping songs for ever new;", action: "Paradox chant: Repetition produces Novelty.", role: "Theologian", func: "MAINTAIN", altars: ["A_TIME", "A_TRUTH"], effect: "Stabilizes fear of boredom." },
        { id: "L25", c: "C3", text: "More happy love! more happy, happy love!", action: "Ecstatic Glossolalia. Overloads meaning.", role: "Ecstatic", func: "TRANSFORM", altars: ["A_DESIRE"], effect: "Transforms language into emotional texture." },
        { id: "L26", c: "C3", text: "For ever warm and still to be enjoy'd,", action: "Sacralizes potentiality.", role: "Lover", func: "MAINTAIN", altars: ["A_DESIRE"], effect: "Maintains moment of highest appetite." },
        { id: "L27", c: "C3", text: "For ever panting, and for ever young;", action: "Freezes physiological arousal.", role: "Lover", func: "MAINTAIN", altars: ["A_DESIRE", "A_TIME"], effect: "Denies aging process." },
        { id: "L28", c: "C3", text: "All breathing human passion far above,", action: "Elevates Urn-World above mortal world.", role: "Judge", func: "REPAIR", altars: ["A_TRUTH"], effect: "Creates vertical cosmology." },
        { id: "L29", c: "C3", text: "That leaves a heart high-sorrowful and cloy'd,", action: "Diagnoses human condition: Satiety = Sickness.", role: "Patient", func: "REPAIR", altars: ["A_DESIRE"], effect: "Validates reader's suffering." },
        { id: "L30", c: "C3", text: "A burning forehead, and a parching tongue.", action: "Seals C3 with fever symptoms.", role: "Patient", func: "REPAIR", altars: ["A_DESIRE"], effect: "Exorcises pain via contrast." },

        // C4
        { id: "L31", c: "C4", text: "Who are these coming to the sacrifice?", action: "Opens Civic Procession. Collective 'Who'.", role: "Citizen", func: "PRODUCE", altars: ["A_COMMUNITY"], effect: "Produces a society, not just lovers." },
        { id: "L32", c: "C4", text: "To what green altar, O mysterious priest,", action: "Acknowledges religious authority.", role: "Novice", func: "MAINTAIN", altars: ["A_COMMUNITY"], effect: "Maintains structure of worship." },
        { id: "L33", c: "C4", text: "Lead'st thou that heifer lowing at the skies,", action: "Enacts visual sacrifice. Earth to Heaven.", role: "Witness", func: "PRODUCE", altars: ["A_SILENCE"], effect: "Evokes sound immediately silenced." },
        { id: "L34", c: "C4", text: "And all her silken flanks with garlands drest?", action: "Adorns the victim. Aestheticizes death.", role: "Decorator", func: "TRANSFORM", altars: ["A_TRUTH"], effect: "Transforms slaughter into beauty." },
        { id: "L35", c: "C4", text: "What little town by river or sea shore,", action: "Conjures the 'Ghost Town' outside the frame.", role: "Architect", func: "PRODUCE", altars: ["A_COMMUNITY"], effect: "Expands geography to include absence." },
        { id: "L36", c: "C4", text: "Or mountain-built with peaceful citadel,", action: "Stabilizes imaginary town with defense.", role: "Architect", func: "PRODUCE", altars: ["A_COMMUNITY"], effect: "Solidifies existence of unseen home." },
        { id: "L37", c: "C4", text: "Is emptied of this folk, this pious morn?", action: "Links crowd to emptiness.", role: "Logician", func: "MAINTAIN", altars: ["A_COMMUNITY", "A_SILENCE"], effect: "Maintains logic: Presence here = Absence there." },
        { id: "L38", c: "C4", text: "And, little town, thy streets for evermore", action: "Apostrophe to the void. Curses with eternity.", role: "Prophet", func: "TRANSFORM", altars: ["A_TIME", "A_SILENCE"], effect: "Transforms festival into desolation." },
        { id: "L39", c: "C4", text: "Will silent be; and not a soul to tell", action: "Removes narrator. History lost.", role: "Historian", func: "TRANSFORM", altars: ["A_SILENCE", "A_COMMUNITY"], effect: "Creates world told only from outside." },
        { id: "L40", c: "C4", text: "Why thou art desolate, can e'er return.", action: "Seals C4 with Desolation.", role: "Mourner", func: "REPAIR", altars: ["A_COMMUNITY"], effect: "Repairs envy by showing cost of eternity." },

        // C5
        { id: "L41", c: "C5", text: "O Attic shape! Fair attitude! with brede", action: "Re-Invocation. Objectifies Urn.", role: "Critic", func: "MAINTAIN", altars: ["A_TRUTH"], effect: "Restores distance between Viewer and Object." },
        { id: "L42", c: "C5", text: "Of marble men and maidens overwrought,", action: "Acknowledges artifice.", role: "Critic", func: "MAINTAIN", altars: ["A_TRUTH"], effect: "Maintains distinction Art vs Life." },
        { id: "L43", c: "C5", text: "With forest branches and the trodden weed;", action: "Notices synthesis of order and chaos.", role: "Observer", func: "MAINTAIN", altars: ["A_TIME"], effect: "Confirms frozen ecosystem." },
        { id: "L44", c: "C5", text: "Thou, silent form, dost tease us out of thought", action: "Mystical Negation. Disables intellect.", role: "Mystic", func: "TRANSFORM", altars: ["A_SILENCE", "A_TRUTH"], effect: "Transforms analysis into awe." },
        { id: "L45", c: "C5", text: "As doth eternity: Cold Pastoral!", action: "Paradoxical Naming. Recognizes indifference.", role: "Realist", func: "REPAIR", altars: ["A_TIME"], effect: "Repairs seduction by admitting coldness." },
        { id: "L46", c: "C5", text: "When old age shall this generation waste,", action: "Memento Mori. Reminds of mortality.", role: "Prophet", func: "MAINTAIN", altars: ["A_TIME"], effect: "Situates ritual in dying generations." },
        { id: "L47", c: "C5", text: "Thou shalt remain, in midst of other woe", action: "Assigns Urn role of Survivor.", role: "Prophet", func: "MAINTAIN", altars: ["A_TIME"], effect: "Guarantees witness for future suffering." },
        { id: "L48", c: "C5", text: "Than ours, a friend to man, to whom thou say'st,", action: "Personifies Urn as benevolent.", role: "Disciple", func: "REPAIR", altars: ["A_COMMUNITY"], effect: "Reclaims 'Cold' object as Friend." },
        { id: "L49", c: "C5", text: "\"Beauty is truth, truth beauty,â€”that is all", action: "The Creed. Circular tautology.", role: "Believer", func: "MAINTAIN", altars: ["A_TRUTH"], effect: "Stabilizes world with final formula." },
        { id: "L50", c: "C5", text: "Ye know on earth, and all ye need to know.\"", action: "Benediction/Seal. Limits epistemology.", role: "Believer", func: "TRANSFORM", altars: ["A_TRUTH"], effect: "Transforms not-knowing into grace." }
    ];

    // --- State ---
    let activeLineId = null;
    let activeFilter = null;
    let processionInterval = null;
    let processionIndex = 0;

    // --- Init ---
    function init() {
        const grid = document.getElementById('grid');
        
        chapels.forEach(chapel => {
            const col = document.createElement('div');
            col.className = 'chapel-column';
            col.innerHTML = `
                <div class="chapel-header">
                    <div class="chapel-title">${chapel.name}</div>
                    <div class="chapel-desc">${chapel.desc}</div>
                </div>
            `;
            
            // Filter lines for this chapel
            const chapelLines = lines.filter(l => l.c === chapel.id);
            chapelLines.forEach(line => {
                const card = document.createElement('div');
                card.className = 'rite-card';
                card.id = `card-${line.id}`;
                card.onclick = () => selectLine(line.id);
                
                // Dots for altars
                const dots = line.altars.map(a => 
                    `<span class="line-marker ${a.toLowerCase().replace('_','-')}"></span>`
                ).join('');

                card.innerHTML = `
                    <div class="line-text">${line.text}</div>
                    <div class="line-meta">
                        <span>${dots} ${line.role}</span>
                        <span>${line.func}</span>
                    </div>
                `;
                col.appendChild(card);
            });

            grid.appendChild(col);
        });
    }

    // --- Interactions ---
    function selectLine(id) {
        // Stop procession if manual interaction
        if (processionInterval && id !== lines[processionIndex].id) stopProcession();

        const line = lines.find(l => l.id === id);
        if (!line) return;

        // Visual State
        document.querySelectorAll('.rite-card').forEach(c => c.classList.remove('active'));
        const card = document.getElementById(`card-${id}`);
        card.classList.add('active');
        
        // Scroll map if needed
        card.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });

        // Update Lectern
        const lectern = document.getElementById('lectern-content');
        
        // Generate Altar Tags
        const tags = line.altars.map(a => 
            `<span class="altar-tag ${a.toLowerCase().replace('_','-')}">${altars[a].name}</span>`
        ).join('');

        lectern.innerHTML = `
            <h2>"${line.text}"</h2>
            
            <div class="ritual-block">
                <span class="ritual-label">Rite Action</span>
                <span class="ritual-value">${line.action}</span>
                
                <span class="ritual-label">World Effect</span>
                <span class="ritual-value">${line.effect}</span>
            </div>

            <div style="margin-top: 1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <span class="ritual-label">Role</span>
                    <span class="role-badge">${line.role}</span>
                </div>
                <div>
                    <span class="ritual-label">Function</span>
                    <strong>${line.func}</strong>
                </div>
            </div>

            <div style="margin-top: 1.5rem;">
                <span class="ritual-label">Altar Connections</span>
                <div class="altar-tags">${tags}</div>
            </div>
        `;
    }

    function filterMap(altarId) {
        activeFilter = altarId;
        
        // Buttons UI
        document.querySelectorAll('.altar-btn').forEach(b => b.classList.remove('active'));
        if (altarId) {
            document.querySelector(`.altar-btn.${altarId.toLowerCase().replace('_','-')}`).classList.add('active');
        }

        // Cards UI
        document.querySelectorAll('.rite-card').forEach(card => {
            const lineId = card.id.replace('card-', '');
            const line = lines.find(l => l.id === lineId);
            
            if (line.altars.includes(altarId)) {
                card.classList.remove('dimmed');
            } else {
                card.classList.add('dimmed');
            }
        });
    }

    function resetFilter() {
        activeFilter = null;
        document.querySelectorAll('.altar-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.rite-card').forEach(c => c.classList.remove('dimmed'));
    }

    // --- Procession Logic ---
    function toggleProcession() {
        const btn = document.getElementById('procBtn');
        if (processionInterval) {
            stopProcession();
        } else {
            startProcession();
        }
    }

    function startProcession() {
        const btn = document.getElementById('procBtn');
        btn.innerText = "Stop Procession";
        btn.style.background = "var(--c-desire)";

        if (activeLineId) {
            // Find index of current line to resume
            processionIndex = lines.findIndex(l => l.id === activeLineId);
        } else {
            processionIndex = 0;
        }

        stepProcession();
        processionInterval = setInterval(stepProcession, 3500); // 3.5s per line
    }

    function stepProcession() {
        if (processionIndex >= lines.length) {
            stopProcession();
            return;
        }
        
        const line = lines[processionIndex];
        selectLine(line.id);
        activeLineId = line.id; // update state specifically for procession
        processionIndex++;
    }

    function stopProcession() {
        clearInterval(processionInterval);
        processionInterval = null;
        const btn = document.getElementById('procBtn');
        btn.innerText = "Start Procession";
        btn.style.background = "";
    }

    // Start
    init();

</script>

</body>
</html>