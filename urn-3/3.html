<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URN_FRIEZE_24x24 // COMPILER</title>
    <style>
        :root {
            --bg-color: #0a0a0a;
            --text-main: #e0e0e0;
            --grid-line: #333;
            --highlight: #ff3e3e;
            --rim-bg: #1a1a1a;
            --frieze-active-bg: #e0e0e0;
            --frieze-active-text: #0a0a0a;
            --frieze-empty-bg: #000000;
            --frieze-empty-text: #555;
            --base-bg: #222;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* HEADER */
        header {
            padding: 10px;
            border-bottom: 1px solid var(--grid-line);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            z-index: 10;
            background: var(--bg-color);
        }

        .status-light {
            width: 8px;
            height: 8px;
            background-color: #0f0;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            box-shadow: 0 0 5px #0f0;
        }

        /* THE GRID CONTAINER */
        #grid-viewport {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
            padding: 10px;
        }

        #urn-grid {
            display: grid;
            grid-template-columns: repeat(24, 1fr);
            grid-template-rows: repeat(24, 1fr);
            width: 95vmin; /* Square relative to viewport min */
            height: 95vmin;
            border: 1px solid var(--grid-line);
            font-size: 0.55vmin; /* Tiny text for the grid */
            line-height: 1;
        }

        .cell {
            border: 1px solid rgba(255,255,255,0.05);
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            cursor: crosshair;
            user-select: none;
            overflow: hidden;
            white-space: nowrap;
            transition: all 0.1s;
        }

        .cell:hover {
            z-index: 10;
            transform: scale(1.5);
            border: 1px solid var(--highlight);
        }

        .cell.highlighted {
            background-color: var(--highlight) !important;
            color: white !important;
            font-weight: bold;
        }

        /* TOPOLOGY ZONES */
        .zone-rim { background-color: var(--rim-bg); color: #888; }
        .zone-frieze-active { background-color: var(--frieze-active-bg); color: var(--frieze-active-text); font-weight: bold; }
        .zone-frieze-empty { background-color: var(--frieze-empty-bg); color: var(--frieze-empty-text); border: 1px dashed #333;}
        .zone-base { background-color: var(--base-bg); color: #aaa; }

        /* ECHO TOKENS (Ghost text) */
        .echo { opacity: 0.3; font-style: italic; }

        /* DECODER / TEXT PANEL */
        #decoder-panel {
            height: 35vh;
            border-top: 2px solid var(--highlight);
            background: #111;
            display: flex;
            flex-direction: column;
        }

        #decoder-header {
            padding: 5px 10px;
            font-size: 0.7rem;
            background: #000;
            color: var(--highlight);
            border-bottom: 1px solid #333;
            display: flex;
            gap: 15px;
        }

        #poem-display {
            overflow-y: auto;
            padding: 15px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .poem-line {
            padding: 2px 5px;
            margin-bottom: 2px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .poem-line:hover { background-color: #222; }
        .poem-line.active { 
            background-color: var(--highlight); 
            color: white; 
            padding-left: 10px;
        }
        
        .stanza-break { margin-bottom: 15px; }

        /* CELL INSPECTOR */
        #cell-data {
            font-size: 0.7rem;
            color: #fff;
            font-family: monospace;
        }

        @media (max-width: 600px) {
            #urn-grid { font-size: 1.8px; } /* Micro text on phones */
            #decoder-panel { height: 40vh; }
        }
    </style>
</head>
<body>

<header>
    <div><span class="status-light"></span>URN_FRIEZE_COMPILER</div>
    <div id="cell-data">HOVER CELL TO DECODE</div>
</header>

<div id="grid-viewport">
    <div id="urn-grid"></div>
</div>

<div id="decoder-panel">
    <div id="decoder-header">
        <span>TOPOLOGY: CYLINDER</span>
        <span>SEED: KEATS_1819</span>
        <span>MODE: OPERATIVE</span>
    </div>
    <div id="poem-display"></div>
</div>

<script>
    // --- DATA: THE POEM ---
    const POEM_DATA = [
        // STANZA 1 (Zone: Rim)
        { text: "Thou still unravish'd bride of quietness,", stanza: 1 },
        { text: "Thou foster-child of silence and slow time,", stanza: 1 },
        { text: "Sylvan historian, who canst thus express", stanza: 1 },
        { text: "A flowery tale more sweetly than our rhyme:", stanza: 1 },
        { text: "What leaf-fring'd legend haunts about thy shape", stanza: 1 },
        { text: "Of deities or mortals, or of both,", stanza: 1 },
        { text: "In Tempe or the dales of Arcady?", stanza: 1 },
        { text: "What men or gods are these? What maidens loth?", stanza: 1 },
        { text: "What mad pursuit? What struggle to escape?", stanza: 1 },
        { text: "What pipes and timbrels? What wild ecstasy?", stanza: 1 },
        
        // STANZA 2 & 3 (Zone: Frieze Active)
        { text: "Heard melodies are sweet, but those unheard", stanza: 2 },
        { text: "Are sweeter; therefore, ye soft pipes, play on;", stanza: 2 },
        { text: "Not to the sensual ear, but, more endear'd,", stanza: 2 },
        { text: "Pipe to the spirit ditties of no tone:", stanza: 2 },
        { text: "Fair youth, beneath the trees, thou canst not leave", stanza: 2 },
        { text: "Thy song, nor ever can those trees be bare;", stanza: 2 },
        { text: "Bold Lover, never, never canst thou kiss,", stanza: 2 },
        { text: "Though winning near the goal yet, do not grieve;", stanza: 2 },
        { text: "She cannot fade, though thou hast not thy bliss,", stanza: 2 },
        { text: "For ever wilt thou love, and she be fair!", stanza: 2 },
        { text: "Ah, happy, happy boughs! that cannot shed", stanza: 3 },
        { text: "Your leaves, nor ever bid the Spring adieu;", stanza: 3 },
        { text: "And, happy melodist, unwearied,", stanza: 3 },
        { text: "For ever piping songs for ever new;", stanza: 3 },
        { text: "More happy love! more happy, happy love!", stanza: 3 },
        { text: "For ever warm and still to be enjoy'd,", stanza: 3 },
        { text: "For ever panting, and for ever young;", stanza: 3 },
        { text: "All breathing human passion far above,", stanza: 3 },
        { text: "That leaves a heart high-sorrowful and cloy'd,", stanza: 3 },
        { text: "A burning forehead, and a parching tongue.", stanza: 3 },

        // STANZA 4 (Zone: Frieze Empty / Negative Space)
        { text: "Who are these coming to the sacrifice?", stanza: 4 },
        { text: "To what green altar, O mysterious priest,", stanza: 4 },
        { text: "Lead'st thou that heifer lowing at the skies,", stanza: 4 },
        { text: "And all her silken flanks with garlands drest?", stanza: 4 },
        { text: "What little town by river or sea shore,", stanza: 4 },
        { text: "Or mountain-built with peaceful citadel,", stanza: 4 },
        { text: "Is emptied of this folk, this pious morn?", stanza: 4 },
        { text: "And, little town, thy streets for evermore", stanza: 4 },
        { text: "Will silent be; and not a soul to tell", stanza: 4 },
        { text: "Why thou art desolate, can e'er return.", stanza: 4 },

        // STANZA 5 (Zone: Base)
        { text: "O Attic shape! Fair attitude! with brede", stanza: 5 },
        { text: "Of marble men and maidens overwrought,", stanza: 5 },
        { text: "With forest branches and the trodden weed;", stanza: 5 },
        { text: "Thou, silent form, dost tease us out of thought", stanza: 5 },
        { text: "As doth eternity: Cold Pastoral!", stanza: 5 },
        { text: "When old age shall this generation waste,", stanza: 5 },
        { text: "Thou shalt remain, in midst of other woe", stanza: 5 },
        { text: "Than ours, a friend to man, to whom thou say'st,", stanza: 5 },
        { text: "\"Beauty is truth, truth beauty,—that is all", stanza: 5 },
        { text: "Ye know on earth, and all ye need to know.\"", stanza: 5 }
    ];

    // --- CONFIG ---
    const GRID_SIZE = 24;
    const TOTAL_CELLS = GRID_SIZE * GRID_SIZE; // 576
    const GRID_EL = document.getElementById('urn-grid');
    const POEM_EL = document.getElementById('poem-display');
    const INFO_EL = document.getElementById('cell-data');

    let cellRegistry = []; // Stores data for each cell

    // --- TOKENIZER & ALLOCATOR ---
    function compileGrid() {
        // 1. Prepare Content Queues
        let qRim = [];
        let qFriezeActive = [];
        let qFriezeEmpty = [];
        let qBase = [];

        // Helper: Tokenize line into words/chunks
        const tokenize = (lineObj, index) => {
            let words = lineObj.text.toUpperCase().split(/\s+/);
            return words.map(w => ({ word: w, lineIndex: index, stanza: lineObj.stanza }));
        };

        // Fill Queues
        POEM_DATA.forEach((line, idx) => {
            let tokens = tokenize(line, idx);
            if (line.stanza === 1) qRim.push(...tokens);
            else if (line.stanza === 2 || line.stanza === 3) qFriezeActive.push(...tokens);
            else if (line.stanza === 4) qFriezeEmpty.push(...tokens);
            else if (line.stanza === 5) qBase.push(...tokens);
        });

        // 2. Generate 24x24 Grid
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                let cellDiv = document.createElement('div');
                cellDiv.className = 'cell';
                cellDiv.dataset.idx = (r * GRID_SIZE) + c;
                
                let cellData = { row: r, col: c, content: "", type: "", lineIndex: -1, zone: "" };

                // --- TOPOLOGY MAPPING LOGIC ---
                
                // ZONE A: RIM (Rows 0-5)
                if (r < 6) {
                    cellDiv.classList.add('zone-rim');
                    cellData.zone = "RIM";
                    cellData = fillCell(cellData, qRim, ["SILENCE", "TIME", "SHAPE"]);
                }
                // ZONE D: BASE (Rows 16-23)
                else if (r >= 16) {
                    cellDiv.classList.add('zone-base');
                    cellData.zone = "BASE";
                    cellData = fillCell(cellData, qBase, ["TRUTH", "BEAUTY", "MARBLE"]);
                }
                // MID SECTION (Rows 6-15)
                else {
                    // ZONE B: FRIEZE ACTIVE (Cols 0-11)
                    if (c < 12) {
                        cellDiv.classList.add('zone-frieze-active');
                        cellData.zone = "FRIEZE_ACTIVE";
                        cellData = fillCell(cellData, qFriezeActive, ["HAPPY", "WARM", "PIPING"]);
                    }
                    // ZONE C: FRIEZE EMPTY (Cols 12-23)
                    else {
                        cellDiv.classList.add('zone-frieze-empty');
                        cellData.zone = "FRIEZE_EMPTY";
                        // Fill logic: Stanza 4 is sparse. Add random gaps.
                        if (Math.random() > 0.4) {
                            cellData = fillCell(cellData, qFriezeEmpty, ["SILENT", "GONE", "EMPTY"]);
                        } else {
                            // Intentional Void
                            cellData.content = "·"; 
                            cellData.type = "VOID";
                            cellDiv.classList.add('echo');
                        }
                    }
                }

                // Render Content
                cellDiv.textContent = cellData.content;
                if(cellData.type === "ECHO") cellDiv.classList.add('echo');

                // Events
                cellDiv.addEventListener('mouseenter', () => handleCellHover(cellData));
                cellDiv.addEventListener('click', () => handleCellClick(cellData));

                GRID_EL.appendChild(cellDiv);
                cellRegistry.push({ el: cellDiv, data: cellData });
            }
        }
    }

    // Helper to pull word from queue or generate echo
    function fillCell(data, queue, echoes) {
        if (queue.length > 0) {
            let token = queue.shift();
            data.content = token.word.replace(/[^A-Z]/g, ''); // Clean punctuation for grid look
            if(data.content.length === 0) data.content = ".";
            data.lineIndex = token.lineIndex;
            data.type = "TEXT";
        } else {
            // Queue empty: Generate Echo
            data.content = echoes[Math.floor(Math.random() * echoes.length)];
            data.type = "ECHO";
        }
        return data;
    }

    // --- RENDER POEM LIST ---
    function renderPoem() {
        let lastStanza = 1;
        POEM_DATA.forEach((line, idx) => {
            if (line.stanza !== lastStanza) {
                let br = document.createElement('div');
                br.className = 'stanza-break';
                POEM_EL.appendChild(br);
                lastStanza = line.stanza;
            }
            let el = document.createElement('div');
            el.className = 'poem-line';
            el.id = `line-${idx}`;
            el.textContent = `[${idx}] ${line.text}`;
            el.addEventListener('click', () => highlightLine(idx));
            POEM_EL.appendChild(el);
        });
    }

    // --- INTERACTION HANDLERS ---

    function handleCellHover(data) {
        let info = `[${data.row},${data.col}] ${data.zone}`;
        if (data.type === "TEXT") info += ` -> LINE ${data.lineIndex}`;
        if (data.type === "ECHO") info += ` -> [ECHO FRAGMENT]`;
        INFO_EL.textContent = info;
    }

    function handleCellClick(data) {
        if (data.lineIndex === -1) return;
        highlightLine(data.lineIndex);
        
        // Scroll poem to line
        const lineEl = document.getElementById(`line-${data.lineIndex}`);
        if(lineEl) lineEl.scrollIntoView({behavior: "smooth", block: "center"});
    }

    function highlightLine(lineIndex) {
        // 1. Reset Styles
        cellRegistry.forEach(c => c.el.classList.remove('highlighted'));
        document.querySelectorAll('.poem-line').forEach(l => l.classList.remove('active'));

        // 2. Highlight Poem Line
        const lineEl = document.getElementById(`line-${lineIndex}`);
        if(lineEl) lineEl.classList.add('active');

        // 3. Highlight Grid Cells
        cellRegistry.forEach(c => {
            if (c.data.lineIndex === lineIndex) {
                c.el.classList.add('highlighted');
            }
        });
    }

    // --- INIT ---
    renderPoem();
    compileGrid();

</script>
</body>
</html>